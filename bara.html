<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è¢«ã‚‰ãªã„ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ V3.5</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&family=Reggae+One&display=swap');

        body {
            font-family: 'DotGothic16', sans-serif;
            background-color: #111;
            color: #fff;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            text-align: center;
            user-select: none;
        }

        .hidden { display: none !important; }
        .screen { 
            width: 100vw; height: 100vh; 
            position: absolute; top: 0; left: 0; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            background-size: cover; background-position: center;
            transition: background 0.5s;
        }

        /* --- Title Screen Styles (Updated V3.5) --- */
        #screen-title { background: #000; background-image: radial-gradient(circle, #333 1px, transparent 1px); background-size: 20px 20px; }
        
        .title-logo {
            font-family: 'Reggae One', cursive;
            font-size: 100px; /* è¿«åŠ›ã‚’å‡ºã™ãŸã‚å°‘ã—å¤§ãã */
            color: #d32f2f; /* æ–‡å­—æœ¬ä½“ã¯èµ¤ */
            position: relative;
            margin-bottom: 40px;
            line-height: 1.2;
            
            /* 1. æ»‘ã‚‰ã‹ãªå¤ªã„æ ç·šï¼ˆé»„è‰²ï¼‰ */
            -webkit-text-stroke: 4px #f1c40f;
            
            /* 2. æ ã®å¤–å´ã®ç™ºå…‰ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ã¨ç«‹ä½“æ„Ÿã®å½± */
            /* drop-shadowã¯è¼ªéƒ­ã«å¯¾ã—ã¦ã‹ã‹ã‚‹ã®ã§ã€é»„è‰²ã®æ ã®å¤–å´ã«ã‚ªãƒ¬ãƒ³ã‚¸ã®ç™ºå…‰ãŒåºƒãŒã‚‹ */
            filter: 
                drop-shadow(0 0 4px #e67e22)  /* æ ã®ã™ãå¤–å´ã®å¼·ã„ã‚ªãƒ¬ãƒ³ã‚¸å…‰ */
                drop-shadow(0 0 15px #e67e22) /* å¤–å´ã«åºƒãŒã‚‹ã‚ªãƒ¬ãƒ³ã‚¸ã®ã¼ã‹ã— */
                drop-shadow(8px 8px 15px rgba(0,0,0,0.9)); /* å…¨ä½“ã®ç«‹ä½“çš„ãªå½± */
        }
        @media (max-width: 600px) { 
            .title-logo { 
                font-size: 60px; 
                -webkit-text-stroke: 3px #f1c40f;
            } 
        }

        .btn-title-start {
            padding: 20px 50px; font-size: 28px; background: #c0392b; border: 4px solid #f1c40f;
            color: #fff; text-shadow: 2px 2px 0 #000; box-shadow: 0 8px 0 #8e2a1f;
            transition: all 0.1s; cursor: pointer; font-family: 'Reggae One', cursive; margin-bottom: 20px;
        }
        .btn-title-start:active { transform: translateY(5px); box-shadow: 0 3px 0 #8e2a1f; }

        .btn-title-settings {
            padding: 10px 30px; font-size: 16px; background: #333; border: 1px solid #777;
            cursor: pointer; color: #aaa; font-family: 'DotGothic16', sans-serif;
        }
        .btn-title-settings:hover { color: #fff; border-color: #fff; background: #444; }

        /* --- Start Options Modal --- */
        .start-options-box {
            background: rgba(0,0,0,0.9); border: 4px double #fff; padding: 30px; border-radius: 10px;
            width: 90%; max-width: 500px;
        }
        .option-row { margin: 20px 0; font-size: 20px; display: flex; justify-content: space-between; align-items: center; }
        .option-row input { width: 80px; font-size: 20px; padding: 5px; }

        /* --- Other UI Components --- */
        button {
            font-family: 'DotGothic16', sans-serif;
            background: #333; color: #fff; border: 1px solid #fff;
            padding: 8px 16px; cursor: pointer; margin: 5px;
            transition: 0.1s;
        }
        button:active { transform: translateY(2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-large { padding: 15px 30px; font-size: 20px; background: #c0392b; border: 2px solid #fff; }
        .btn-confirm { background: #e67e22; color: #000; font-weight: bold; }

        input[type="text"], input[type="number"] {
            padding: 5px; background: #000; color: #fff; border: 1px solid #777; text-align: center;
        }

        /* --- Setup Screen --- */
        #setup-container {
            width: 95%; max-width: 800px; height: 90vh;
            overflow-y: auto; background: #222; border: 4px double #777;
            padding: 20px; box-sizing: border-box; text-align: left;
        }
        .setup-section { margin-bottom: 20px; border-bottom: 1px dashed #555; padding-bottom: 20px; }
        .setup-section h3 { color: #f1c40f; margin-top: 0; }
        
        .floor-config-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 5px;
            background: #333; padding: 5px;
        }
        .floor-label { width: 40px; font-weight: bold; }

        .q-list-item {
            background: #333; padding: 5px; margin-bottom: 2px;
            display: flex; justify-content: space-between; font-size: 14px;
        }

        /* --- Game Screen --- */
        .dungeon-header {
            position: absolute; top: 0; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 20px; box-sizing: border-box;
            z-index: 10; text-shadow: 2px 2px 0 #000;
        }
        .floor-indicator { font-size: 40px; color: #f1c40f; font-family: 'Reggae One', cursive; }
        .timer-box { font-size: 32px; border: 2px solid #fff; padding: 5px 15px; background: rgba(0,0,0,0.7); }
        .timer-warning { color: #e74c3c; animation: blink 0.5s infinite; }

        /* Enemy Area */
        .enemy-area {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            width: 100%; position: relative; z-index: 5;
        }
        .enemy-img { 
            max-width: 60%; max-height: 40vh; object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.8));
            animation: float 3s ease-in-out infinite;
        }
        .question-box {
            background: rgba(0,0,0,0.85); border: 4px double #fff; padding: 20px;
            font-size: 26px; width: 85%; margin-top: 20px; min-height: 60px;
            border-radius: 8px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Answers Grid */
        .answers-grid {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
            width: 95%; padding-bottom: 20px; z-index: 10; min-height: 120px;
        }
        .answer-card {
            background: #222; border: 2px solid #777; padding: 10px;
            width: 130px; min-height: 80px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: 0.2s; cursor: pointer;
        }
        .p-name { font-size: 12px; color: #aaa; }
        .p-ans { font-size: 20px; font-weight: bold; word-break: break-all; }
        
        .answer-card.selected-ng { 
            background: #c0392b !important; border-color: #e74c3c !important; transform: scale(1.05); 
        }
        .answer-card.selected-ng::after {
            content: "è¢«ã‚Š!"; position: absolute; top: -5px; right: -5px; font-weight:bold;
            background: #fff; color: #c0392b; padding: 2px 6px; font-size: 14px; border: 2px solid #c0392b;
        }

        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes blink { 50% { opacity: 0.5; } }
        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; background: #300 !important; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-5px, 0, 0); }
            20%, 80% { transform: translate3d(10px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-10px, 0, 0); }
            40%, 60% { transform: translate3d(10px, 0, 0); }
        }
        .slash-effect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150vw; height: 20px; background: #fff; box-shadow: 0 0 20px #fff;
            animation: slash 0.4s ease-out; z-index: 100;
        }
        @keyframes slash {
            0% { width: 0; transform: translate(-50%, -50%) rotate(-45deg); opacity: 1; }
            100% { width: 250vw; transform: translate(-50%, -50%) rotate(-45deg); opacity: 0; }
        }

        /* Player Screen */
        #screen-player { padding: 20px; box-sizing: border-box; background: #222; }
    </style>
</head>
<body>

<audio id="bgm-player" loop></audio>

<div id="screen-title" class="screen">
    <h1 class="title-logo">è¢«ã‚‰ãªã„ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</h1>
    
    <button class="btn-title-start" onclick="showStartOptions()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    
    <br>
    
    <button class="btn-title-settings" onclick="showScreen('screen-setup')">è¨­å®šï¼ˆç´ æãƒ»BGMãƒ»ãŠé¡Œï¼‰</button>
</div>


<div id="screen-start-options" class="screen hidden" style="background:rgba(0,0,0,0.8);">
    <div class="start-options-box">
        <h2 style="color:#f1c40f; margin-top:0;">ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š</h2>
        
        <div class="option-row">
            <label>å‚åŠ äººæ•°</label>
            <div>
                <input type="number" id="opt-players" value="4" min="2" style="width:60px;"> äºº
            </div>
        </div>
        
        <div class="option-row">
            <label>åˆ¶é™æ™‚é–“</label>
            <div>
                <input type="number" id="opt-time" value="300" step="30" style="width:60px;"> ç§’
            </div>
        </div>

        <div style="margin-top:30px;">
            <button class="btn-large" onclick="goToLobby()">ãƒ­ãƒ“ãƒ¼ã‚’ä½œæˆ</button>
            <br>
            <button class="btn-title-settings" onclick="showScreen('screen-title')" style="margin-top:10px;">æˆ»ã‚‹</button>
        </div>
    </div>
</div>


<div id="screen-setup" class="screen hidden" style="background:#111; overflow: auto; display:block; position:relative;">
    <div style="display:flex; justify-content:center; align-items:center; height:100vh;">
        <div id="setup-container">
            <h2 style="text-align:center; color:#e74c3c; margin:0 0 20px 0;">è©³ç´°è¨­å®š</h2>
            
            <div class="setup-section">
                <h3>1. BGMè¨­å®š</h3>
                <label>BGMãƒ•ã‚¡ã‚¤ãƒ« (MP3ç­‰): <input type="file" id="file-bgm" accept="audio/*"></label>
                <p style="font-size:12px; color:#aaa;">â€»è¨­å®šã™ã‚‹ã¨ã‚²ãƒ¼ãƒ ä¸­ã«ãƒ«ãƒ¼ãƒ—å†ç”Ÿã•ã‚Œã¾ã™</p>
            </div>

            <div class="setup-section">
                <h3>2. éšå±¤ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« (èƒŒæ™¯ãƒ»æ•µç”»åƒ)</h3>
                <p style="font-size:12px; color:#aaa;">â€»è¨­å®šã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºã«ãªã‚Šã¾ã™</p>
                <div id="visual-config-area">
                    </div>
            </div>

            <div class="setup-section">
                <h3>3. ãŠé¡Œç™»éŒ²</h3>
                <p style="font-size:12px; color:#aaa;">
                    ãŠé¡Œã¨ã€Œæœ‰åŠ¹å›ç­”æ•°(ç›®å®‰)ã€ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚<br>
                    <strong>å‚åŠ äººæ•°ã«å¿œã˜ã¦ã€é©åˆ‡ãªãŠé¡Œã‚’åŒºé–“ã”ã¨ã«ãƒ©ãƒ³ãƒ€ãƒ é¸å‡ºã—ã¾ã™ã€‚</strong><br>
                    â€»ãŠé¡ŒãŒãŸãã•ã‚“ã‚ã‚‹ã»ã©ã€æ¯å›é•ã†å•é¡ŒãŒå‡ºã‚„ã™ããªã‚Šã¾ã™ã€‚
                </p>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="q-text" placeholder="ãŠé¡Œ (ä¾‹: éƒ½é“åºœçœŒ)" style="flex:1; text-align:left;">
                    <input type="number" id="q-count" placeholder="å›ç­”æ•°" style="width:60px;">
                    <button onclick="addQuestion()">è¿½åŠ </button>
                </div>
                <div id="question-list" style="max-height:150px; overflow-y:auto; border:1px solid #555;"></div>
                <div style="text-align:right; font-size:12px; color:#f1c40f;" id="q-status">ç¾åœ¨ 0 å•</div>
            </div>

            <div style="text-align:center; margin-top: 20px;">
                <button class="btn-large" onclick="saveSettingsAndBack()">ä¿å­˜ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
                <br>
                <button class="btn-title-settings" onclick="showScreen('screen-title')" style="margin-top:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
</div>

<div id="screen-lobby" class="screen hidden" style="background:#222;">
    <h2 style="font-family: 'Reggae One', cursive; color:#f1c40f;">å†’é™ºè€…ã‚’å‹Ÿé›†ä¸­...</h2>
    <div style="background:#fff; padding:10px; border: 4px double #333;">
        <div id="qrcode"></div>
    </div>
    <p id="lobby-url" style="font-size:14px; color:#aaa; margin-top:10px; user-select: text;"></p>
    <div id="lobby-members" style="margin: 20px; font-size: 28px; color:#2ecc71; font-family: 'Reggae One', cursive;">å‚åŠ è€…: 0äºº</div>
    <button class="btn-title-start" id="btn-start-game" onclick="startGame()" disabled>ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã¸æŒ‘ã‚€</button>
    <br>
    <button class="btn-title-settings" onclick="showScreen('screen-title')" style="margin-top:20px;">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<div id="screen-host" class="screen hidden">
    <div class="dungeon-header">
        <div class="floor-indicator">B<span id="disp-floor">1</span></div>
        <div class="timer-box" id="game-timer">00:00</div>
    </div>

    <div class="enemy-area">
        <div id="slash-layer"></div>
        <img src="" id="enemy-img" class="enemy-img" style="display:none;"> <div id="enemy-placeholder" style="font-size:120px; filter: drop-shadow(0 0 10px #fff);">ğŸ‘¾</div> <div class="question-box" id="question-text">---</div>
        
        <div style="margin-top:20px; height: 50px;">
            <button id="btn-open" onclick="openAnswers()" class="hidden btn-title-start" style="font-size:20px; padding:10px 30px;">å›ç­”ã‚ªãƒ¼ãƒ—ãƒ³</button>
            <div id="judge-ui" class="hidden">
                <span style="font-size:16px; background:#000; padding:5px; color:#e74c3c; border:2px solid #e74c3c; display:block; margin-bottom:10px;">è¢«ã‚Š(NG)ã®å›ç­”ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã›ã‚ˆï¼</span>
                <button onclick="confirmJudgement()" class="btn-confirm btn-large">åˆ¤å®šç¢ºå®šï¼ˆæ”»æ’ƒï¼ï¼‰</button>
            </div>
        </div>
    </div>

    <div class="answers-grid" id="answers-container"></div>
</div>

<div id="screen-result" class="screen hidden" style="background:#000;">
    <h1 id="res-title" style="font-family: 'Reggae One', cursive; font-size: 80px; color: #f1c40f; text-shadow: 5px 5px 0 #000;">CLEAR</h1>
    <button class="btn-title-settings" onclick="location.reload()" style="font-size:24px; padding:15px 30px;">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<div id="screen-login" class="screen hidden" style="background:#222;">
    <h2 style="font-family: 'Reggae One', cursive; color:#e67e22;">å†’é™ºè€…ã‚®ãƒ«ãƒ‰</h2>
    <input type="text" id="p-name-input" placeholder="åå‰ã‚’å…¥åŠ›" style="width:250px; font-size:24px; padding:10px;">
    <br><br>
    <button class="btn-title-start" onclick="joinGame()" style="font-size:24px; padding:15px 40px;">ç™»éŒ²</button>
</div>

<div id="screen-player" class="screen hidden">
    <div class="player-status" id="p-status" style="font-size:28px; color:#f1c40f; font-family: 'Reggae One', cursive;">å¾…æ©Ÿä¸­...</div>
    <div style="background:#333; padding:20px; border:4px double #777; border-radius:10px; width:90%; margin-bottom:30px;">
        <div style="color:#aaa; font-size:14px; margin-bottom:5px;">ä»Šå›ã®ãŠé¡Œ</div>
        <div id="p-question" style="font-size:24px; font-weight:bold;"></div>
    </div>
    <input type="text" id="p-ans-input" placeholder="å›ç­”ã‚’å…¥åŠ›" style="width:90%; font-size:24px; padding:15px;">
    <br><br>
    <button class="btn-large" id="p-send-btn" onclick="sendAnswer()" style="width:90%; background:#27ae60; font-size:28px; padding:20px;">é€ä¿¡</button>
</div>


<script>
    // --- Data Management ---
    const MAX_FLOOR = 7;
    let config = {
        players: 4, // Default, overwritten by start options
        time: 300,  // Default, overwritten by start options
        questions: [], 
        assets: {}
    };

    // Default questions
    const DEFAULT_QS = [
        {text:"éƒ½é“åºœçœŒ(47)", count:47}, {text:"ä¸–ç•Œã®å›½(196)", count:196}, {text:"å…ƒç´ è¨˜å·(118)", count:118},
        {text:"å±±æ‰‹ç·šã®é§…(30)", count:30}, {text:"ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ(26)", count:26}, {text:"å°†æ£‹ã®é§’(8)", count:8},
        {text:"å¹²æ”¯(12)", count:12}, {text:"æ˜Ÿåº§(12)", count:12}, {text:"å¤ªé™½ç³»ã®æƒ‘æ˜Ÿ(8)", count:8}, 
        {text:"è™¹ã®è‰²(7)", count:7}, {text:"ç¡¬è²¨ã®ç¨®é¡(6)", count:6}, {text:"äº”å¤§é™¸(5)", count:5}, 
        {text:"å­£ç¯€(4)", count:4}, {text:"ä¿¡å·æ©Ÿã®è‰²(3)", count:3}, {text:"ã˜ã‚ƒã‚“ã‘ã‚“ã®æ‰‹(3)", count:3}
    ];

    // Game State
    let peer, conn, myId;
    let players = {};
    let currentFloor = 1;
    let floorQuestions = {}; 
    let timerInterval, remainingTime;

    // --- INITIALIZATION ---
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('host')) {
            // Player Mode
            setupPeer(false, urlParams.get('host'));
        } else {
            // Host Mode
            showScreen('screen-title');
            initSetupUI(); // Prepare settings UI behind the scenes
        }
    };

    // --- SETUP UI LOGIC (Detailed Settings) ---
    function initSetupUI() {
        for(let i=1; i<=MAX_FLOOR; i++) config.assets[i] = { bg: null, enemy: null };

        const container = document.getElementById('visual-config-area');
        for(let i=1; i<=MAX_FLOOR; i++) {
            const row = document.createElement('div');
            row.className = 'floor-config-row';
            row.innerHTML = `
                <div class="floor-label">${i}F</div>
                <label style="font-size:12px;">èƒŒæ™¯:<input type="file" id="bg-${i}" accept="image/*" style="width:150px;"></label>
                <label style="font-size:12px;">æ•µ:<input type="file" id="enemy-${i}" accept="image/*" style="width:150px;"></label>
            `;
            container.appendChild(row);
        }
    }

    function addQuestion() {
        const txt = document.getElementById('q-text').value;
        const cnt = parseInt(document.getElementById('q-count').value);
        if(!txt || !cnt) return alert("ãŠé¡Œã¨å›ç­”æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        config.questions.push({ text: txt, count: cnt });
        
        const list = document.getElementById('question-list');
        const item = document.createElement('div');
        item.className = 'q-list-item';
        item.innerHTML = `<span>${txt}</span><span>(ç›®å®‰:${cnt})</span>`;
        list.appendChild(item);

        document.getElementById('q-text').value = "";
        document.getElementById('q-count').value = "";
        document.getElementById('q-status').innerText = `ç¾åœ¨ ${config.questions.length} å•`;
    }

    // "Settings" screen: save assets/questions/bgm
    function saveSettingsAndBack() {
        // 1. Merge Defaults if empty
        if(config.questions.length < MAX_FLOOR * 2) {
            config.questions = [...config.questions, ...DEFAULT_QS];
        }

        // 2. BGM
        const bgmFile = document.getElementById('file-bgm').files[0];
        if(bgmFile) {
            const audio = document.getElementById('bgm-player');
            audio.src = URL.createObjectURL(bgmFile);
            audio.volume = 0.3;
        }

        // 3. Assets
        for(let i=1; i<=MAX_FLOOR; i++) {
            const bgFile = document.getElementById(`bg-${i}`).files[0];
            const enFile = document.getElementById(`enemy-${i}`).files[0];
            if(bgFile) config.assets[i].bg = URL.createObjectURL(bgFile);
            if(enFile) config.assets[i].enemy = URL.createObjectURL(enFile);
        }

        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        showScreen('screen-title');
    }

    // --- GAME START FLOW ---
    function showStartOptions() {
        showScreen('screen-start-options');
    }

    function goToLobby() {
        // Apply Player Count & Time from Start Options
        config.players = parseInt(document.getElementById('opt-players').value);
        config.time = parseInt(document.getElementById('opt-time').value);

        // Ensure questions exist (if user skipped Settings screen)
        if(config.questions.length === 0) {
            config.questions = [...DEFAULT_QS];
        }

        // Generate Floor Questions based on Player Count
        generateFloorQuestions();

        showScreen('screen-lobby');
        if(!peer) setupPeer(true);
    }

    function generateFloorQuestions() {
        let validQ = config.questions.filter(q => q.count >= config.players);
        
        if (validQ.length < MAX_FLOOR) {
            validQ = [...config.questions]; // Fallback
        }
        
        validQ.sort((a, b) => b.count - a.count); // Descending

        for(let i=1; i<=MAX_FLOOR; i++) {
            const total = validQ.length;
            const startIdx = Math.floor( (i - 1) * total / MAX_FLOOR );
            const endIdx = Math.floor( i * total / MAX_FLOOR );
            let bucket = validQ.slice(startIdx, endIdx);
            
            if(bucket.length === 0 && startIdx < total) bucket = [validQ[startIdx]];
            if(bucket.length === 0) bucket = [validQ[total - 1]];
            
            const pick = bucket[Math.floor(Math.random() * bucket.length)];
            floorQuestions[i] = pick.text;
        }
    }

    // --- PEER JS ---
    function setupPeer(isHost, hostId=null) {
        peer = new Peer();
        peer.on('open', id => {
            myId = id;
            if(isHost) {
                const url = `${location.href.split('?')[0]}?host=${myId}`;
                new QRCode(document.getElementById("qrcode"), { text: url, width: 128, height: 128 });
                document.getElementById('lobby-url').innerText = url;
            } else {
                showScreen('screen-login');
            }
        });
        peer.on('connection', c => {
            c.on('open', () => c.on('data', d => handleData(c, d)));
            connections[c.peer] = c;
        });
        peer.on('error', e => alert("Connection Error: " + e));
    }

    // --- HOST GAME LOGIC ---
    function handleData(c, data) {
        if(data.type === 'JOIN') {
            players[c.peer] = { name: data.name, answer: null, id: c.peer };
            updateLobby();
            c.send({ type: 'JOIN_OK' });
        } else if (data.type === 'ANSWER') {
            if(players[c.peer]) {
                players[c.peer].answer = data.answer;
                updateGridHost();
            }
        }
    }

    function updateLobby() {
        const cnt = Object.keys(players).length;
        document.getElementById('lobby-members').innerText = `å‚åŠ è€…: ${cnt}äºº / ${config.players}äºº`;
        if(cnt >= 1) document.getElementById('btn-start-game').disabled = false;
    }

    function startGame() {
        const audio = document.getElementById('bgm-player');
        if(audio.src) audio.play();

        broadcast({ type: 'START' });
        currentFloor = 1;
        remainingTime = config.time;
        showScreen('screen-host');
        startTimer();
        loadFloor();
    }

    function loadFloor() {
        // Visuals
        const screen = document.getElementById('screen-host');
        screen.classList.remove('shake-screen');
        const asset = config.assets[currentFloor];
        
        if (asset && asset.bg) {
            screen.style.backgroundImage = `url(${asset.bg})`;
            screen.style.backgroundSize = "cover";
        } else {
            screen.style.backgroundImage = "none";
            screen.style.background = "#222"; 
        }

        const enemyImg = document.getElementById('enemy-img');
        const enemyPh = document.getElementById('enemy-placeholder');
        enemyImg.style.opacity = "1"; enemyPh.style.opacity = "1";

        if (asset && asset.enemy) {
            enemyImg.src = asset.enemy;
            enemyImg.style.display = "block";
            enemyPh.style.display = "none";
        } else {
            enemyImg.style.display = "none";
            enemyPh.style.display = "block";
        }

        // Text
        document.getElementById('disp-floor').innerText = currentFloor;
        document.getElementById('question-text').innerText = floorQuestions[currentFloor];

        // Reset
        Object.keys(players).forEach(id => players[id].answer = null);
        document.getElementById('btn-open').classList.add('hidden');
        document.getElementById('judge-ui').classList.add('hidden');
        
        updateGridHost();
        broadcast({ type: 'QUESTION', text: floorQuestions[currentFloor] });
    }

    function updateGridHost() {
        const container = document.getElementById('answers-container');
        if(!document.getElementById('btn-open').classList.contains('hidden') || !document.getElementById('judge-ui').classList.contains('hidden')) return;

        container.innerHTML = "";
        let ansCount = 0;
        
        Object.values(players).forEach(p => {
            const card = document.createElement('div');
            card.className = "answer-card";
            if(p.answer) {
                ansCount++;
                card.innerHTML = `<div class="p-name">${p.name}</div><div class="p-ans" style="color:#f39c12">å›ç­”æ¸ˆ</div>`;
            } else {
                card.innerHTML = `<div class="p-name">${p.name}</div><div class="p-ans" style="color:#555">...</div>`;
            }
            container.appendChild(card);
        });

        if(ansCount === Object.keys(players).length && ansCount > 0) {
            document.getElementById('btn-open').classList.remove('hidden');
        }
    }

    function openAnswers() {
        document.getElementById('btn-open').classList.add('hidden');
        const container = document.getElementById('answers-container');
        container.innerHTML = "";

        const counts = {};
        Object.values(players).forEach(p => {
            if(!p.answer) return;
            const v = p.answer.trim().toLowerCase(); 
            counts[v] = (counts[v] || 0) + 1;
        });

        Object.values(players).forEach(p => {
            const card = document.createElement('div');
            card.className = "answer-card";
            card.innerHTML = `<div class="p-name">${p.name}</div><div class="p-ans">${p.answer}</div>`;
            
            if(counts[p.answer.trim().toLowerCase()] > 1) {
                card.classList.add('selected-ng');
            }

            card.onclick = () => card.classList.toggle('selected-ng');
            container.appendChild(card);
        });

        document.getElementById('judge-ui').classList.remove('hidden');
    }

    function confirmJudgement() {
        const ngCards = document.querySelectorAll('.answer-card.selected-ng');
        const isFail = ngCards.length > 0;

        document.getElementById('judge-ui').classList.add('hidden');

        if(isFail) {
            document.getElementById('screen-host').classList.add('shake-screen');
            setTimeout(() => {
                document.getElementById('screen-host').classList.remove('shake-screen');
                if(currentFloor === 1) {
                    endGame(false);
                } else {
                    currentFloor--;
                    loadFloor();
                }
            }, 1000);
        } else {
            const slash = document.getElementById('slash-layer');
            slash.classList.add('slash-effect');
            document.getElementById('enemy-img').style.opacity = 0;
            document.getElementById('enemy-placeholder').style.opacity = 0;
            
            setTimeout(() => {
                slash.classList.remove('slash-effect');
                if(currentFloor === MAX_FLOOR) {
                    endGame(true);
                } else {
                    currentFloor++;
                    loadFloor();
                }
            }, 500);
        }
    }

    function startTimer() {
        const el = document.getElementById('game-timer');
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            remainingTime--;
            const m = Math.floor(remainingTime/60).toString().padStart(2,'0');
            const s = (remainingTime%60).toString().padStart(2,'0');
            el.innerText = `${m}:${s}`;
            if(remainingTime<=30) el.classList.add('timer-warning');
            if(remainingTime<=0) {
                clearInterval(timerInterval);
                endGame(false, "TIME UP");
            }
        }, 1000);
    }

    function endGame(isClear, msg="") {
        clearInterval(timerInterval);
        showScreen('screen-result');
        const t = document.getElementById('res-title');
        t.innerText = isClear ? "GAME CLEAR!!" : "GAME OVER";
        t.style.color = isClear ? "#f1c40f" : "#e74c3c";
        broadcast({ type: 'END', isClear: isClear });
    }

    function broadcast(data) {
        Object.values(connections).forEach(c => c.send(data));
    }

    // --- PLAYER LOGIC ---
    let hostConn;
    function joinGame() {
        const name = document.getElementById('p-name-input').value;
        if(!name) return alert("åå‰ã‚’å…¥åŠ›");
        const urlParams = new URLSearchParams(window.location.search);
        hostConn = peer.connect(urlParams.get('host'));
        hostConn.on('open', () => {
            hostConn.send({ type:'JOIN', name:name });
            showScreen('screen-player');
            document.getElementById('p-send-btn').disabled = true;
        });
        hostConn.on('data', d => {
            if(d.type === 'START') {
                document.getElementById('p-status').innerText = "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼";
            } else if(d.type === 'QUESTION') {
                document.getElementById('p-status').innerText = "å›ç­”ã—ã¦ãã ã•ã„";
                document.getElementById('p-question').innerText = d.text;
                document.getElementById('p-ans-input').value = "";
                document.getElementById('p-ans-input').disabled = false;
                document.getElementById('p-send-btn').disabled = false;
                document.getElementById('p-send-btn').innerText = "é€ä¿¡";
                document.getElementById('p-send-btn').style.background = "#27ae60";
            } else if(d.type === 'END') {
                document.getElementById('p-status').innerText = d.isClear ? "ã‚¯ãƒªã‚¢ï¼" : "çµ‚äº†...";
                document.getElementById('p-ans-input').disabled = true;
                document.getElementById('p-send-btn').disabled = true;
            }
        });
    }

    function sendAnswer() {
        const val = document.getElementById('p-ans-input').value;
        if(!val) return;
        hostConn.send({ type:'ANSWER', answer:val });
        document.getElementById('p-status').innerText = "å¾…æ©Ÿä¸­...";
        document.getElementById('p-ans-input').disabled = true;
        document.getElementById('p-send-btn').disabled = true;
        document.getElementById('p-send-btn').innerText = "é€ä¿¡æ¸ˆ";
        document.getElementById('p-send-btn').style.background = "#555";
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
