<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card Master V27 (Dual Marker)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/cv.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/aruco.js"></script>

    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        #canvas-container {
            position: relative; width: 100%; max-width: 640px; 
            background: #222; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        canvas { display: block; width: 100%; height: auto; }
        #proc-canvas { display: none; } /* å†…éƒ¨å‡¦ç†ç”¨ */

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .game-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }
        
        button, .btn-float, .judge-btn { cursor: pointer; pointer-events: auto; }
        .btn-float { 
            background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #fff; 
            padding: 8px 15px; border-radius: 20px; font-size: 12px; margin: 10px; 
        }
        .judge-btn { 
            width: 80%; padding: 15px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 50px; 
            color: white; background: linear-gradient(to bottom, #28a745, #208030); 
            align-self: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #ar-guide-msg {
            position: absolute; top:10px; left:50%; transform:translateX(-50%);
            color: #fff; font-size:12px; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px;
            pointer-events: none; text-align: center; width: 90%; line-height: 1.4;
        }

        /* çµæœè¡¨ç¤ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #result-overlay {
            display:none; position:absolute; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.85); flex-direction:column; justify-content:center; align-items:center; z-index:50;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ»è¨­å®šã‚¨ãƒªã‚¢ */
        #controls { width: 90%; max-width: 600px; background: #222; padding: 10px; border-radius: 10px; margin-top: 10px; z-index: 5; }
        .slider-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        input[type=range] { width: 100%; cursor: grab; }

        #settings-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #151515; z-index: 200; transform: translateY(100%); 
            transition: transform 0.3s; padding: 20px; overflow-y: auto; box-sizing: border-box; 
        }
        #settings-overlay.open { transform: translateY(0); }
        .setting-box { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }
        
        .card-list { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; min-height: 80px;}
        .card-thumb { 
            min-width: 60px; height: 80px; background: #000; border: 1px solid #555; border-radius:4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .card-thumb img { width: 100%; height: 100%; object-fit: contain; }
        .btn-mini { padding: 4px 8px; font-size: 11px; border-radius: 4px; border: none; margin-left: 5px; color: #fff;}
        .btn-edit { background: #007bff; } .btn-del { background: #dc3545; }
        
        #status-msg { 
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
            background: rgba(40,167,69,0.95); padding: 8px 20px; border-radius: 20px; 
            font-size:12px; opacity:0; transition:opacity 0.5s; z-index:300; pointer-events: none;
        }
        video { display: none; }
    </style>
</head>
<body>

<div id="canvas-container">
    <canvas id="main-canvas"></canvas>
    <canvas id="proc-canvas"></canvas>
    
    <div id="ar-guide-msg">
        <b>ID:0ï½3ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã€Œå¯¾è§’ç·šã€ã«2ã¤ç½®ã„ã¦ãã ã•ã„</b><br>
        <span style="color:#aaa; font-size:10px;">ä¾‹: ãƒãƒ¼ã‚«ãƒ¼0ã‚’ã‚«ãƒ¼ãƒ‰ã®[å·¦ä¸‹]ã¨[å³ä¸Š]ã«ç½®ãã¨èªè­˜ã•ã‚Œã¾ã™</span>
    </div>

    <div class="game-ui">
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-float" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
            <button class="btn-float" onclick="toggleDebug()">ç¯„å›²èª¿æ•´: <span id="debug-status">100%</span></button>
        </div>
        
        <div id="result-overlay" onclick="this.style.display='none'">
            <div id="res-msg" style="font-size:3rem; font-weight:bold;"></div>
            <div style="margin-top:20px; color:#ccc;">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</div>
        </div>

        <button id="btn-judge" class="judge-btn" onclick="judge()">åˆ¤ å®š !</button>
    </div>
</div>

<div id="controls">
    <div class="slider-row">
        <span>ç¯„å›²ã®åºƒãŒã‚Š <span id="val-margin">1.0</span></span>
        <span>ç™½é»’æ„Ÿåº¦ <span id="val-thr">100</span></span>
    </div>
    <input type="range" min="0.8" max="1.5" step="0.05" value="1.0" oninput="updateParam('margin', this.value)">
    <input type="range" min="10" max="250" value="100" oninput="updateParam('thr', this.value)" style="margin-top:5px;">
    <div style="text-align:center; font-size:10px; color:#aaa; margin-top:5px;">
        â€»é’ã„æ ç·šãŒã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’å›²ã‚€ã‚ˆã†ã«ã€Œç¯„å›²ã€ã‚’èª¿æ•´ã—ã¦ãã ã•ã„
    </div>
</div>

<div id="status-msg"></div>
<video id="video-source" autoplay playsinline muted></video>

<div id="settings-overlay">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <h2>è¨­å®šãƒ»ç™»éŒ²</h2><button onclick="closeSettings()" class="btn-float" style="margin:0; background:#555;">é–‰ã˜ã‚‹</button>
    </div>
    
    <div class="setting-box">
        <h3>1. ã‚«ãƒ¼ãƒ‰ç”»åƒç™»éŒ²</h3>
        <input type="text" id="reg-name" placeholder="ã‚«ãƒ¼ãƒ‰å" style="width:100%; padding:10px; margin-bottom:5px; box-sizing:border-box;">
        <div style="background:#333; padding:8px; margin-bottom:10px; border-radius:4px;">
            <label style="cursor:pointer; display:flex; align-items:center;">
                <input type="checkbox" id="is-blank-check" style="width:20px; margin-right:5px;"> ç©ºç™½ã¨ã—ã¦ç™»éŒ²
            </label>
        </div>
        <label class="btn-float" style="display:block; text-align:center; margin:0; background:#007bff; border:none; font-size:14px; padding:12px;">
            ğŸ“ ç”»åƒã‚’é¸æŠ
            <input type="file" accept="image/*" onchange="registerImage(this)" style="display:none;">
        </label>
        <div class="card-list" id="reg-list" style="margin-top:10px;"></div>
    </div>

    <div class="setting-box">
        <h3>2. æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½œæˆ</h3>
        <input type="text" id="lvl-name" placeholder="å•é¡Œå (ä¾‹: å•1)" style="width:100%; padding:10px; margin-bottom:5px; box-sizing:border-box;">
        <p style="font-size:11px; color:#aaa;">ID:0ï½3 ã®ãƒãƒ¼ã‚«ãƒ¼é–“ã«ç½®ãã¹ãã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
            <div><span style="font-size:10px;">ID:0</span><select id="sel-0" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:1</span><select id="sel-1" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:2</span><select id="sel-2" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:3</span><select id="sel-3" style="width:100%;"></select></div>
        </div>
        <button onclick="addLevel()" style="width:100%; padding:10px; background:#28a745; color:#fff; border:none; border-radius:5px;">ï¼‹ è¿½åŠ </button>
        <div id="level-list" style="margin-top:10px;"></div>
    </div>
    
    <div class="setting-box"><button onclick="resetData()" style="width:100%; padding:10px; background:#d00; color:#fff; border:none; border-radius:5px;">âš  ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤</button></div>
</div>

<script>
    // --- å®šæ•° ---
    const PROC_W = 100; // å†…éƒ¨å‡¦ç†å¹…
    const PROC_H = 140; // å†…éƒ¨å‡¦ç†é«˜ã• (ã‚«ãƒ¼ãƒ‰æ¯”ç‡)

    // --- å¤‰æ•° ---
    let cards = [];
    let levels = [];
    let blankData = null;
    let detectedNames = ["?","?","?","?"];
    let currentTarget = [];
    
    let threshold = 100;
    let marginScale = 1.0; // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®ä½™ç™½å€ç‡
    let detector = null;

    // DOM
    const video = document.getElementById('video-source');
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const procCanvas = document.getElementById('proc-canvas');
    const procCtx = procCanvas.getContext('2d');

    window.onload = () => {
        loadData(); renderUI(); startCamera();
        if(typeof AR !== 'undefined') detector = new AR.Detector();
        procCanvas.width = PROC_W; procCanvas.height = PROC_H;
    };

    function updateParam(k, v) {
        if(k==='thr') { threshold=parseInt(v); document.getElementById('val-thr').innerText=v; }
        if(k==='margin') { marginScale=parseFloat(v); document.getElementById('debug-status').innerText=Math.round(marginScale*100)+"%"; }
    }
    function toggleDebug() { marginScale = (marginScale===1.0)?1.2:1.0; document.getElementById('debug-status').innerText=Math.round(marginScale*100)+"%"; document.querySelector('input[type=range]').value=marginScale; }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } });
            video.srcObject = stream;
            video.onloadedmetadata = () => { canvas.width=video.videoWidth; canvas.height=video.videoHeight; requestAnimationFrame(loop); };
        } catch(e) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼"); }
    }

    function loop() {
        if(video.readyState !== 4) { requestAnimationFrame(loop); return; }
        
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // ArUcoæ¤œå‡º
        let markers = [];
        if(detector) {
            markers = detector.detect(imgData);
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’IDã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        let markersById = [[], [], [], []];
        markers.forEach(m => {
            if(m.id >= 0 && m.id <= 3) markersById[m.id].push(m);
        });

        // åˆ¤å®šçµæœã®ä¸€æ™‚ä¿å­˜
        let currentDetection = ["?","?","?","?"];

        // å„IDã«ã¤ã„ã¦å‡¦ç†
        for(let id=0; id<4; id++) {
            const ms = markersById[id];
            
            // åŒã˜IDãŒã€Œ2ã¤ã€è¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿ã€ãã®é–“ã‚’ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã¨ã™ã‚‹
            if(ms.length === 2) {
                // 2ã¤ã®ãƒãƒ¼ã‚«ãƒ¼ã®ä¸­å¿ƒåº§æ¨™ã‚’å–å¾—
                const c1 = getCenter(ms[0].corners);
                const c2 = getCenter(ms[1].corners);

                // 2ç‚¹ã‚’å¯¾è§’ç·šã¨ã™ã‚‹çŸ©å½¢ã‚’å®šç¾© (ãƒãƒ¼ã‚¸ãƒ³é©ç”¨)
                const rect = getBoundingRect(c1, c2, marginScale);

                // çŸ©å½¢é ˜åŸŸã‚’å†…éƒ¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã¸Warp (Perspective Correction)
                // ç°¡æ˜“çš„ã«4ç‚¹ã‚’å®šç¾©: TL, TR, BR, BL
                const srcPoints = [
                    rect.x, rect.y,                   // TL
                    rect.x + rect.w, rect.y,          // TR
                    rect.x + rect.w, rect.y + rect.h, // BR
                    rect.x, rect.y + rect.h           // BL
                ];
                const dstPoints = [0,0, PROC_W,0, PROC_W,PROC_H, 0,PROC_H];
                
                const H = getHomography(srcPoints, dstPoints);
                warpImage(imgData, procCtx, H);

                // åˆ¤å®šå‡¦ç†
                const procData = procCtx.getImageData(0,0,PROC_W, PROC_H);
                const bin = binarize(procData);
                const feat = getFeature(bin, PROC_W, PROC_H);
                const best = identifyCard(feat);
                
                currentDetection[id] = best;

                // ARè¡¨ç¤º (èªè­˜ã‚¨ãƒªã‚¢ã¨çµæœ)
                drawAR(ctx, rect, id, best);
            }
        }

        // æ¤œå‡ºçŠ¶æ³ã‚’æ›´æ–° (æ¤œå‡ºã•ã‚Œã¦ã„ãªã„ã¨ãã¯å‰å›ã®å€¤ã‚’ç¶­æŒã›ãšã€?ã«ã™ã‚‹)
        detectedNames = currentDetection;

        requestAnimationFrame(loop);
    }

    // --- è¨ˆç®—é–¢æ•° ---
    
    function getCenter(corners) {
        let x=0, y=0;
        corners.forEach(p => { x+=p.x; y+=p.y; });
        return {x:x/4, y:y/4};
    }

    function getBoundingRect(p1, p2, scale) {
        // 2ç‚¹ã‚’å«ã‚€ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹
        const minX = Math.min(p1.x, p2.x);
        const maxX = Math.max(p1.x, p2.x);
        const minY = Math.min(p1.y, p2.y);
        const maxY = Math.max(p1.y, p2.y);
        
        const w = maxX - minX;
        const h = maxY - minY;
        const cx = minX + w/2;
        const cy = minY + h/2;

        // ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨ (ä¸­å¿ƒåŸºæº–ã§æ‹¡å¤§)
        const nw = w * scale;
        const nh = h * scale;
        
        return {
            x: cx - nw/2,
            y: cy - nh/2,
            w: nw,
            h: nh
        };
    }

    function identifyCard(feat) {
        let best = "?"; let minD = 1.0;
        cards.forEach(c => {
            if(c.isBlank) return;
            const diff = compare(feat, c.data);
            if(diff < minD) { minD = diff; best = c.name; }
        });
        if(blankData) {
            const bDiff = compare(feat, blankData);
            if(bDiff < minD) { minD = bDiff; best = ""; } 
        }
        // åˆ¤å®šé–¾å€¤ (ç·©ã‚ã«è¨­å®š: 0.4ä»¥ä¸‹ãªã‚‰ä¸€è‡´ã¨ã¿ãªã™)
        return minD > 0.4 ? "?" : best;
    }

    // --- æç”»é–¢æ•° ---
    function drawAR(ctx, r, id, name) {
        // èªè­˜æ 
        ctx.strokeStyle = (name !== "?") ? "cyan" : "rgba(255,255,255,0.5)";
        ctx.lineWidth = 3;
        ctx.strokeRect(r.x, r.y, r.w, r.h);

        // ãƒãƒ¼ã‚«ãƒ¼æ¥ç¶šç·š (å¯¾è§’ç·š)
        ctx.strokeStyle = "rgba(255,255,0,0.3)";
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(r.x, r.y+r.h); ctx.lineTo(r.x+r.w, r.y); ctx.stroke(); // BL to TR

        // ãƒ©ãƒ™ãƒ«
        ctx.fillStyle = "white"; 
        ctx.shadowColor="black"; ctx.shadowBlur=4;
        
        // ID
        ctx.font = "bold 12px sans-serif";
        ctx.fillText("ID:"+id, r.x, r.y - 5);

        // çµæœ
        ctx.font = "bold 24px sans-serif";
        ctx.textAlign = "center";
        const disp = (name === "") ? "ç©ºç™½" : name;
        ctx.fillText(disp, r.x + r.w/2, r.y + r.h/2 + 8);
        ctx.shadowBlur=0; ctx.textAlign = "start";
    }

    // --- å…±é€šã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  ---
    function getHomography(src,dst){let A=[],B=[];for(let i=0;i<4;i++){let sx=src[i*2],sy=src[i*2+1],dx=dst[i*2],dy=dst[i*2+1];A.push([sx,sy,1,0,0,0,-sx*dx,-sy*dx]);A.push([0,0,0,sx,sy,1,-sx*dy,-sy*dy]);B.push(dx);B.push(dy);}return solveGaussian(A,B).concat([1.0]);}
    function solveGaussian(A,B){let n=A.length;let x=new Array(n);for(let i=0;i<n;i++){let max=Math.abs(A[i][i]),r=i;for(let k=i+1;k<n;k++)if(Math.abs(A[k][i])>max){max=Math.abs(A[k][i]);r=k;}for(let k=i;k<n;k++){let t=A[r][k];A[r][k]=A[i][k];A[i][k]=t;}let t=B[r];B[r]=B[i];B[i]=t;for(let k=i+1;k<n;k++){let c=-A[k][i]/A[i][i];for(let j=i;j<n;j++)if(i==j)A[k][j]=0;else A[k][j]+=c*A[i][j];B[k]+=c*B[i];}}for(let i=n-1;i>=0;i--){let s=0;for(let j=i+1;j<n;j++)s+=A[i][j]*x[j];x[i]=(B[i]-s)/A[i][i];}return x;}
    function invertMatrix(m){const n11=m[0],n12=m[1],n13=m[2],n21=m[3],n22=m[4],n23=m[5],n31=m[6],n32=m[7],n33=m[8],t11=n33*n22-n32*n23,t12=n32*n13-n33*n12,t13=n23*n12-n22*n13,det=n11*t11+n21*t12+n31*t13;if(det===0)return m;const i=1/det;return[t11*i,(n31*n23-n33*n21)*i,(n32*n21-n31*n22)*i,t12*i,(n33*n11-n31*n13)*i,(n31*n12-n32*n11)*i,t13*i,(n21*n13-n23*n11)*i,(n22*n11-n21*n12)*i];}
    function warpImage(src,ctxDst,H){const w=ctxDst.canvas.width,h=ctxDst.canvas.height,dstD=ctxDst.createImageData(w,h),dd=dstD.data,srcD=src.data,sw=src.width,sh=src.height,Hi=invertMatrix(H);for(let y=0;y<h;y++)for(let x=0;x<w;x++){const u=Hi[0]*x+Hi[1]*y+Hi[2],v=Hi[3]*x+Hi[4]*y+Hi[5],s=Hi[6]*x+Hi[7]*y+Hi[8],sx=Math.floor(u/s),sy=Math.floor(v/s),di=(y*w+x)*4;if(sx>=0&&sx<sw&&sy>=0&&sy<sh){const si=(sy*sw+sx)*4;dd[di]=srcD[si];dd[di+1]=srcD[si+1];dd[di+2]=srcD[si+2];dd[di+3]=255;}else dd[di+3]=0;}ctxDst.putImageData(dstD,0,0);}
    function binarize(d){const b=new ImageData(d.width,d.height),bd=b.data,dd=d.data;for(let i=0;i<dd.length;i+=4){const v=(dd[i]+dd[i+1]+dd[i+2])/3<threshold?0:255;bd[i]=bd[i+1]=bd[i+2]=v;bd[i+3]=255;}return b;}
    function getFeature(b,w,h){const p=[],d=b.data,step=3;for(let y=0;y<h;y+=step)for(let x=0;x<w;x+=step)p.push(d[((y*w+x)*4)]===0?1:0);return p;}
    function compare(a,b){if(!a||!b||a.length!=b.length)return 1;let d=0,c=0;for(let i=0;i<a.length;i++){if(a[i]!=b[i])d++;c++;}return c?d/c:1;}

    // --- UI/Data ---
    function registerImage(input) {
        if(!input.files[0]) return;
        const name = document.getElementById('reg-name').value || "Card"+(cards.length+1);
        const isBlank = document.getElementById('is-blank-check').checked;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image(); img.onload = () => {
                const c = document.createElement('canvas'); c.width=PROC_W; c.height=PROC_H;
                const t = c.getContext('2d'); t.drawImage(img,0,0,PROC_W,PROC_H);
                const bin = binarize(t.getImageData(0,0,PROC_W,PROC_H));
                const data = getFeature(bin,PROC_W,PROC_H);
                t.putImageData(bin,0,0);
                const thumb = c.toDataURL();
                const nc = {name,data,thumb,isBlank};
                if(isBlank){ blankData=data; cards=cards.filter(x=>!x.isBlank); cards.unshift(nc); } else cards.push(nc);
                saveData(); renderUI(); input.value=""; showToast("ç™»éŒ²: "+name);
            }; img.src=e.target.result;
        }; r.readAsDataURL(input.files[0]);
    }
    function addLevel(){ levels.push({title:document.getElementById('lvl-name').value||"ç„¡é¡Œ",order:[0,1,2,3].map(i=>document.getElementById('sel-'+i).value)}); saveData(); renderUI(); }
    function judge(){
        if(!levels.length){alert("æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“");return;}
        const target = currentTarget.length ? currentTarget : levels[0].order;
        let ok=true;
        for(let i=0;i<4;i++) if(detectedNames[i] !== target[i]) ok=false;
        document.getElementById('result-overlay').style.display='flex';
        const m=document.getElementById('res-msg'); m.innerText=ok?"æ­£è§£!!":"ä¸æ­£è§£..."; m.style.color=ok?"#0f0":"#f00";
    }
    function renderUI(){
        const cl=document.getElementById('reg-list'); cl.innerHTML="";
        cards.forEach((c,i)=>{cl.innerHTML+=`<div class="card-thumb" style="${c.isBlank?'border:2px dashed #0f0':''}"><img src="${c.thumb}"><div style="font-size:10px;">${c.name}</div><div style="position:absolute;top:0;right:0;background:red;width:20px;text-align:center;cursor:pointer;color:white;" onclick="delCard(${i})">Ã—</div></div>`;});
        for(let i=0;i<4;i++){const s=document.getElementById('sel-'+i); s.innerHTML="<option value=''>- ç©ºç™½ -</option>"; cards.forEach(c=>{if(!c.isBlank)s.innerHTML+=`<option value="${c.name}">${c.name}</option>`});}
        const ll=document.getElementById('level-list'); ll.innerHTML="";
        levels.forEach((l,i)=>{ll.innerHTML+=`<div style="background:#333;padding:5px;margin-bottom:5px;border-radius:4px;display:flex;justify-content:space-between;"><div><b>${l.title}</b><div style="font-size:10px;color:#aaa;">${l.order.join(',')}</div></div><div><button class="btn-mini btn-edit" onclick="selLevel(${i})">é¸æŠ</button><button class="btn-mini btn-del" onclick="delLevel(${i})">å‰Šé™¤</button></div></div>`;});
    }
    function delCard(i){if(confirm("å‰Šé™¤?")){cards.splice(i,1);saveData();renderUI();}}
    function delLevel(i){levels.splice(i,1);saveData();renderUI();}
    function selLevel(i){currentTarget=levels[i].order; showToast("é¸æŠ: "+levels[i].title); closeSettings();}
    function saveData(){localStorage.setItem('cm_v27',JSON.stringify({cards,levels,blankData}));}
    function loadData(){const d=localStorage.getItem('cm_v27');if(d){const j=JSON.parse(d);cards=j.cards||[];levels=j.levels||[];blankData=j.blankData;}}
    function resetData(){if(confirm("å…¨æ¶ˆå»?")){localStorage.clear();location.reload();}}
    function showToast(m){const e=document.getElementById('status-msg');e.innerText=m;e.style.opacity=1;setTimeout(()=>e.style.opacity=0,2000);}
    function openSettings(){document.getElementById('settings-overlay').classList.add('open');}
    function closeSettings(){document.getElementById('settings-overlay').classList.remove('open');}
</script>
</body>
</html>
