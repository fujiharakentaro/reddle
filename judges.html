<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card Master V17 (Direct View)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* ãƒ¡ã‚¤ãƒ³ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆCanvasã‚’ã“ã“ã«è¡¨ç¤ºï¼‰ */
        #canvas-container {
            position: relative;
            width: 100%; max-width: 640px;
            aspect-ratio: 16 / 9; /* ã‚«ãƒ¡ãƒ©æ¯”ç‡ã«å›ºå®š */
            background: #222;
            box-shadow: 0 0 20px rgba(0,255,0,0.2);
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }
        .ui-element { pointer-events: auto; }

        /* å„ç¨®ãƒœã‚¿ãƒ³ */
        .btn-float { background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #fff; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; margin: 10px; }
        .judge-btn { 
            width: 80%; padding: 15px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 50px; 
            color: white; background: linear-gradient(to bottom, #28a745, #208030); 
            align-self: center; margin-bottom: 20px; pointer-events: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* èª¿æ•´ãƒ‘ãƒãƒ« */
        #controls {
            width: 90%; max-width: 600px; background: #222; padding: 10px; border-radius: 10px; margin-top: 10px;
        }
        .slider-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        input[type=range] { width: 100%; }

        /* è¨­å®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #settings-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #151515; z-index: 200; transform: translateY(100%); transition: transform 0.3s; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        #settings-overlay.open { transform: translateY(0); }
        .setting-box { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        
        .card-list { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; min-height: 80px;}
        .card-thumb { min-width: 60px; height: 80px; background: #000; border: 1px solid #555; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;}
        .card-thumb img { width: 100%; height: 100%; object-fit: contain; }
        
        input[type="text"], select { padding: 10px; width: 100%; margin-bottom: 5px; box-sizing: border-box; background: #333; color: #fff; border: 1px solid #555; border-radius: 5px;}
        .level-item { background: #333; padding: 10px; margin-bottom: 5px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }

        /* çµæœè¡¨ç¤º */
        #result-view { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: none; z-index: 400; flex-direction: column; justify-content: center; align-items: center; }
        
        /* ãã®ä»– */
        #status-msg { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(40,167,69,0.9); padding: 5px 15px; border-radius: 20px; font-size:12px; opacity:0; transition:opacity 0.5s; z-index:300; }
        #sync-area { display:none; background:#fff; padding:10px; border-radius:8px; text-align:center; margin-top:10px;}
        video { display: none; } /* ãƒ“ãƒ‡ã‚ªã‚¿ã‚°ã¯éè¡¨ç¤ºï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã™ã‚‹ãŸã‚ï¼‰ */
    </style>
</head>
<body>

<div id="canvas-container">
    <canvas id="main-canvas"></canvas>
    <div class="ui-layer">
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-float ui-element" onclick="startCam(true)">ğŸ“· å†èµ·å‹•</button>
            <button class="btn-float ui-element" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
        </div>
        <button id="btn-judge" class="judge-btn" onclick="judge()" style="display:none;">åˆ¤ å®š !</button>
        
        <div id="title-ui" style="text-align:center; margin-top:20%; pointer-events:auto;">
            <h1 style="text-shadow:0 0 10px #000;">CARD MASTER</h1>
            <div id="level-list" style="background:rgba(0,0,0,0.8); padding:10px; border-radius:10px; max-height:200px; overflow-y:auto; width:80%; margin:0 auto;"></div>
        </div>
    </div>
</div>

<div id="controls">
    <div class="slider-row">
        <span>ç™½é»’æ„Ÿåº¦ (Threshold) <span id="val-thr">90</span></span>
        <span>åˆ¤å®šã®ç”˜ã• <span id="val-tol">0.6</span></span>
    </div>
    <input type="range" min="10" max="200" value="90" oninput="updateParam('thr', this.value)">
    <input type="range" min="0.1" max="1.0" step="0.05" value="0.6" oninput="updateParam('tol', this.value)" style="margin-top:5px;">
    <div style="font-size:10px; color:#aaa; margin-top:5px;">
        â€»ç”»é¢ã®é»„è‰²ã„æ ã®ä¸­ã«ã‚«ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚<br>
        â€»çµµæŸ„ãŒã¯ã£ãã‚Šè¦‹ãˆã‚‹ã‚ˆã†ã«ä¸Šã®ãƒãƒ¼(æ„Ÿåº¦)ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
    </div>
</div>

<div id="status-msg">ä¿å­˜ã—ã¾ã—ãŸ</div>
<video id="video-source" autoplay playsinline muted></video>

<div id="settings-overlay">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <h2>è¨­å®š</h2><button onclick="closeSettings()" class="btn-float" style="margin:0;">é–‰ã˜ã‚‹</button>
    </div>
    <div class="setting-box">
        <h3>1. ç”»åƒç™»éŒ²</h3>
        <p style="font-size:12px; color:#f88;">â€»æœ€åˆã«ã€Œå…¨å‰Šé™¤ã€ã—ã¦ãã ã•ã„</p>
        <input type="text" id="reg-name" placeholder="åå‰">
        <div style="background:#333; padding:5px; margin-bottom:5px;"><label><input type="checkbox" id="is-blank-check"> ã“ã‚Œã‚’ã€Œç©ºç™½ã€ã«ã™ã‚‹</label></div>
        <label style="display:block; background:#007bff; padding:10px; text-align:center; border-radius:5px; cursor:pointer;">ğŸ“ ç”»åƒã‚’é¸æŠ<input type="file" accept="image/*" onchange="registerImage(this)" style="display:none;"></label>
        <div class="card-list" id="reg-list"></div>
    </div>
    <div class="setting-box">
        <h3>2. å•é¡Œä½œæˆ</h3>
        <input type="hidden" id="edit-index" value="-1">
        <input type="text" id="lvl-name" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <select id="sel-0"></select><select id="sel-1"></select><select id="sel-2"></select><select id="sel-3"></select>
        </div>
        <button id="add-btn" onclick="addLevel()" style="width:100%; padding:10px; background:#28a745; color:#fff; border:none; border-radius:5px;">ï¼‹ è¿½åŠ </button>
        <div id="set-lvl-list" style="margin-top:10px;"></div>
    </div>
    <div class="setting-box">
        <button onclick="downloadHTML()" style="width:100%; padding:10px; background:#007bff; color:#fff; border:none; border-radius:5px; margin-bottom:5px;">ğŸ’¾ HTMLä¿å­˜</button>
        <button onclick="startHost()" style="width:100%; padding:10px; background:#007bff; color:#fff; border:none; border-radius:5px; margin-bottom:5px;">ğŸ“¡ QRåŒæœŸ</button>
        <button onclick="resetData()" style="width:100%; padding:10px; background:#d00; color:#fff; border:none; border-radius:5px;">âš  å…¨å‰Šé™¤ (ãƒªã‚»ãƒƒãƒˆ)</button>
        <div id="sync-area"><div id="qrcode"></div><div id="sync-msg" style="color:#000; font-size:11px;">å¾…æ©Ÿä¸­...</div></div>
    </div>
</div>

<div id="result-view" onclick="this.style.display='none'">
    <div id="res-msg" style="font-size:4rem; font-weight:bold;"></div>
    <div>Tap to close</div>
</div>

<script id="embedded-data" type="application/json">null</script>

<script>
    // --- å®šæ•°ãƒ»å¤‰æ•° ---
    const PROC_W = 320; const PROC_H = 180; // å†…éƒ¨è§£åƒåº¦(16:9)
    // æ ã®å®šç¾© (ç”»é¢å…¨ä½“ã«å¯¾ã™ã‚‹å‰²åˆ)
    const SLOT_W_PCT = 0.20; 
    const GAP_PCT = 0.05;
    const START_X = (1.0 - (SLOT_W_PCT*4 + GAP_PCT*3)) / 2; // ä¸­å¤®å¯„ã›
    const SLOT_X_PCT = [
        START_X, 
        START_X + SLOT_W_PCT + GAP_PCT, 
        START_X + (SLOT_W_PCT + GAP_PCT)*2, 
        START_X + (SLOT_W_PCT + GAP_PCT)*3
    ];

    let cards=[], levels=[], blankData=null;
    let currentOrder=[], detected=["","","",""];
    let isGameMode = false;
    
    let threshold = 90; 
    let tolerance = 0.6;

    const video = document.getElementById('video-source');
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');

    // --- åˆæœŸåŒ– ---
    window.onload = () => {
        canvas.width = PROC_W; canvas.height = PROC_H; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºå›ºå®š
        try {
            const txt = document.getElementById('embedded-data').textContent;
            if(txt && txt!=="null") { const d=JSON.parse(txt); cards=d.cards; levels=d.levels; blankData=d.blank; }
            else loadLocal();
        } catch(e){ loadLocal(); }
        
        renderUI(); startCam();
        
        const u = new URLSearchParams(window.location.search);
        if(u.get('sync')) startClient(u.get('sync'));
    };

    function updateParam(type, val) {
        if(type==='thr') { threshold=parseInt(val); document.getElementById('val-thr').innerText=threshold; }
        if(type==='tol') { tolerance=parseFloat(val); document.getElementById('val-tol').innerText=tolerance>=0.8?"ç„¡ç†ã‚„ã‚Š":tolerance.toFixed(2); }
    }

    // --- ã‚«ãƒ¡ãƒ© & æç”»ãƒ«ãƒ¼ãƒ— ---
    async function startCam(manual=false) {
        if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } });
            video.srcObject = s;
            video.onloadedmetadata = () => { video.play(); setInterval(loop, 100); }; // ãƒ«ãƒ¼ãƒ—é–‹å§‹
            if(manual) showToast("å†èµ·å‹•ã—ã¾ã—ãŸ");
        } catch(e) { 
            navigator.mediaDevices.getUserMedia({video:true}).then(s=>{ video.srcObject=s; video.onloadedmetadata=()=>{video.play();};});
        }
    }

    function loop() {
        if(video.readyState !== 4) return;
        
        // 1. æ˜ åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”» (å…¨ç”»é¢)
        ctx.drawImage(video, 0, 0, PROC_W, PROC_H);
        
        // 2. å‡¦ç†ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾— (å…¨ä½“)
        const imgData = ctx.getImageData(0, 0, PROC_W, PROC_H);
        const bin = binarize(imgData); // 2å€¤åŒ–ãƒ‡ãƒ¼ã‚¿
        
        // 3. ç”»é¢ã¸ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æç”» (ãƒ‡ãƒãƒƒã‚°ç”¨ç™½é»’ & æ )
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œã‚·ã‚¹ãƒ†ãƒ ãŒè¦‹ã¦ã„ã‚‹ç™½é»’ç”»é¢ã€ã‚’è¦‹ã›ã‚‹ï¼ˆã“ã‚ŒãŒä¸€ç•ªç¢ºå®Ÿï¼‰
        ctx.putImageData(bin, 0, 0); 
        
        // æ ã®æç”»
        ctx.strokeStyle = "#0f0"; ctx.lineWidth = 2;
        ctx.fillStyle = "#0f0"; ctx.font = "10px Arial";
        
        const scanH = PROC_H * 0.4; // åˆ¤å®šã‚¨ãƒªã‚¢é«˜ã•
        const scanY = (PROC_H - scanH) / 2;

        let detectedNow = [];

        for(let i=0; i<4; i++) {
            const cx = SLOT_X_PCT[i] * PROC_W;
            const cw = SLOT_WIDTH_PCT * PROC_W;
            
            // åˆ¤å®šã‚¨ãƒªã‚¢ï¼ˆå°‘ã—å†…å´ã‚’è¦‹ã‚‹ï¼‰
            const cutW = Math.floor(cw * 0.7);
            const cutX = Math.floor(cx + (cw - cutW)/2);
            
            // æ æç”»
            ctx.strokeRect(cutX, scanY, cutW, scanH);
            
            // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
            const feat = getFeature(bin, cutX, scanY, cutW, scanH, PROC_W);
            let best = "?"; let minD = 1.0;

            cards.forEach(c => {
                if(c.isBlank) return;
                // â˜…ã‚ºãƒ¬è£œæ­£ã‚ã‚Šæ¯”è¼ƒ (Shift Match)
                // å·¦å³ã«4ãƒ”ã‚¯ã‚»ãƒ«ãšã¤ãšã‚‰ã—ã¦ä¸€ç•ªä¼¼ã¦ã„ã‚‹ã¨ã“ã‚ã‚’æ¢ã™
                const diff = compareShift(feat, c.data, cutW, scanH, 4); 
                if(diff < minD) { minD = diff; best = c.name; }
            });

            if(blankData) {
                const bDiff = compareShift(feat, blankData, cutW, scanH, 4);
                if(bDiff < minD) { best = ""; minD = bDiff; }
            }

            if(minD > tolerance) best = "?";
            
            detectedNow.push(best);
            
            // çµæœã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã«æ–‡å­—ã§æ›¸ã
            const disp = best==="" ? "(ç©ºç™½)" : best;
            ctx.fillText(`${disp}`, cutX, scanY + scanH + 12);
            ctx.fillText(`(${minD.toFixed(2)})`, cutX, scanY + scanH + 22);
        }
        detected = detectedNow;
    }

    // --- ç™»éŒ²å‡¦ç† ---
    function registerImage(input) {
        if(!input.files[0]) return;
        const name = document.getElementById('reg-name').value || "Img"+(cards.length+1);
        const isBlank = document.getElementById('is-blank-check').checked;
        const r = new FileReader();
        r.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                // ç™»éŒ²ç”¨ä¸€æ™‚ã‚­ãƒ£ãƒ³ãƒã‚¹
                const c = document.createElement('canvas');
                // Slot1 (Index 0) ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã¦åˆã‚ã›ã‚‹
                const cw = SLOT_WIDTH_PCT * PROC_W;
                const cutW = Math.floor(cw * 0.7);
                const scanH = PROC_H * 0.4;
                
                c.width = cutW; c.height = scanH;
                const tx = c.getContext('2d');
                tx.drawImage(img, 0, 0, cutW, scanH); // ãƒªã‚µã‚¤ã‚ºæç”»
                
                const b = binarize(tx.getImageData(0,0,cutW,scanH));
                const data = getFeature(b, 0, 0, cutW, scanH, cutW);
                
                tx.putImageData(b, 0, 0); // ã‚µãƒ ãƒç”¨
                const thumb = c.toDataURL();

                if(isBlank) {
                    blankData = data;
                    cards = cards.filter(x=>!x.isBlank);
                    cards.unshift({name:"ã€ç©ºç™½ã€‘"+name, data, thumb, isBlank:true});
                } else {
                    cards.push({name, data, thumb, isBlank:false});
                }
                saveLocal(); renderUI();
                input.value="";
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(input.files[0]);
    }

    // --- ã‚³ã‚¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (ã‚ºãƒ¬è£œæ­£) ---
    function binarize(d) {
        const bin=new ImageData(d.width,d.height); const bd=bin.data; const dd=d.data;
        for(let i=0;i<dd.length;i+=4) {
            const v = (dd[i]+dd[i+1]+dd[i+2])/3 < threshold ? 0 : 255;
            bd[i]=bd[i+1]=bd[i+2]=v; bd[i+3]=255;
        }
        return bin;
    }
    
    function getFeature(b,x,y,w,h,tw) {
        const p=[]; const d=b.data; 
        // å‡¦ç†é«˜é€ŸåŒ–ã®ãŸã‚è§£åƒåº¦ã‚’å°‘ã—è½ã¨ã™ (step=2)
        const step=2; 
        for(let py=0; py<h; py+=step) for(let px=0; px<w; px+=step) {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“åº§æ¨™(x+px, y+py)ã‹ã‚‰å–å¾—
            const idx = ((y+py)*tw + (x+px)) * 4;
            p.push(d[idx]===0 ? 1 : 0);
        }
        return p;
    }

    // ã‚ºãƒ¬è£œæ­£ä»˜ãæ¯”è¼ƒ (Shift Match)
    // a: ã‚«ãƒ¡ãƒ©ç‰¹å¾´, b: ç™»éŒ²ç‰¹å¾´ (bã®æ–¹ãŒæ­£)
    // width, height: ç‰¹å¾´é‡æŠ½å‡ºæ™‚ã®ã‚µã‚¤ã‚º(stepè€ƒæ…®å‰)
    function compareShift(a, b, w, h, shiftRange) {
        if(!a || !b || a.length !== b.length) return 1.0;
        
        let minDiff = 1.0;
        const step = 2; // getFeatureã¨åŒã˜step
        const sw = Math.floor(w/step); // ç‰¹å¾´é‡é…åˆ—ã¨ã—ã¦ã®å¹…
        
        // ä¸Šä¸‹å·¦å³ã«ãšã‚‰ã—ã¦æ¯”è¼ƒã™ã‚‹ã®ã¯é‡ã„ã®ã§ã€ãƒ‡ãƒ¼ã‚¿é…åˆ—ã‚’ã‚·ãƒ•ãƒˆã—ã¦ç°¡æ˜“æ¯”è¼ƒ
        // ã“ã“ã§ã¯å˜ç´”åŒ–ã—ã¦ã€Œé…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚ºãƒ¬ã€ã¨ã—ã¦è¿‘ä¼¼ã™ã‚‹
        // 1ãƒ”ã‚¯ã‚»ãƒ«ã‚ºãƒ¬ = é…åˆ—ä¸Šã§1è¦ç´ ã‚ºãƒ¬
        
        // ã‚»ãƒ³ã‚¿ãƒ¼æ¯”è¼ƒ
        minDiff = Math.min(minDiff, simpleCompare(a, b));
        
        // ç°¡æ˜“ã‚·ãƒ•ãƒˆæ¯”è¼ƒ (å‰å¾Œæ•°ãƒ”ã‚¯ã‚»ãƒ«åˆ†ãšã‚‰ã—ã¦æ¯”è¼ƒ)
        // â€»å³å¯†ãª2æ¬¡å…ƒã‚·ãƒ•ãƒˆã¯é‡ã„ãŒã€ã“ã‚Œã§ååˆ†åŠ¹æœãŒã‚ã‚‹
        for(let s=1; s<=shiftRange; s++) {
            // å³ã«ã‚ºãƒ¬ãŸå ´åˆ (aã‚’å³ã«ãšã‚‰ã™ = indexã‚’æ¸›ã‚‰ã™)
            minDiff = Math.min(minDiff, simpleCompare(a, b, s));
            // å·¦ã«ã‚ºãƒ¬ãŸå ´åˆ
            minDiff = Math.min(minDiff, simpleCompare(a, b, -s));
        }
        
        return minDiff;
    }

    function simpleCompare(a, b, offset=0) {
        let diff = 0;
        let count = 0;
        const len = a.length;
        
        for(let i=0; i<len; i++) {
            let ai = i + offset;
            if(ai >= 0 && ai < len) {
                if(a[ai] !== b[i]) diff++;
                count++;
            }
        }
        return count===0 ? 1.0 : diff/count;
    }

    // --- UIåˆ¶å¾¡ ---
    function addLevel() {
        const t = document.getElementById('lvl-name').value || "ç„¡é¡Œ";
        const o = [0,1,2,3].map(i => document.getElementById(`sel-${i}`).value);
        const idx = parseInt(document.getElementById('edit-index').value);
        if(idx>=0) levels[idx]={title:t, order:o}; else levels.push({title:t, order:o});
        saveLocal(); renderUI(); closeSettings();
    }
    
    function editLevel(i) {
        const l=levels[i]; document.getElementById('lvl-name').value=l.title;
        for(let j=0;j<4;j++) document.getElementById(`sel-${j}`).value=l.order[j];
        document.getElementById('edit-index').value=i;
        document.getElementById('add-btn').innerText="æ›´æ–°";
    }

    function renderUI() {
        const cl = document.getElementById('reg-list'); cl.innerHTML="";
        cards.forEach((c,i)=>{
            cl.innerHTML+=`<div class="card-thumb" style="${c.isBlank?'border:2px solid #0f0':''}"><img src="${c.thumb}"><div class="card-name">${c.name}</div><div style="position:absolute;top:0;right:0;background:red;width:20px;color:white;text-align:center;cursor:pointer;" onclick="if(confirm('å‰Šé™¤?')){cards.splice(${i},1);if(c.isBlank)blankData=null;saveLocal();renderUI();}">Ã—</div></div>`;
        });
        for(let i=0;i<4;i++){
            const s=document.getElementById(`sel-${i}`); const v=s.value; s.innerHTML="<option value=''>- ç©ºç™½ -</option>";
            cards.forEach(c=>{ if(!c.isBlank) s.innerHTML+=`<option value='${c.name}'>${c.name}</option>`; });
            s.value=v;
        }
        const ll = document.getElementById('level-list'); ll.innerHTML="";
        const sl = document.getElementById('set-lvl-list'); sl.innerHTML="";
        levels.forEach((l,i)=>{
            const item = `<div class="level-item" onclick="startGame(${i})"><span>${l.title}</span><span style="font-size:12px;">â–¶</span></div>`;
            ll.innerHTML+=item;
            sl.innerHTML+=`<div style="display:flex;justify-content:space-between;background:#333;margin-bottom:5px;padding:5px;"><span style="font-size:12px;">${l.title}</span><div><button onclick="editLevel(${i})" style="margin-right:5px;">âœ</button><button onclick="levels.splice(${i},1);saveLocal();renderUI();">ğŸ—‘ï¸</button></div></div>`;
        });
    }

    function startGame(i) { currentTarget=levels[i].order; isGameMode=true; updateScreen(); }
    function goTitle() { isGameMode=false; updateScreen(); }
    function updateScreen() {
        document.getElementById('btn-judge').style.display = isGameMode ? 'block' : 'none';
        document.getElementById('title-ui').style.display = isGameMode ? 'none' : 'block';
    }
    
    function judge() { 
        const isMatch = JSON.stringify(detected) === JSON.stringify(currentTarget); 
        const m = document.getElementById('res-msg'); 
        m.innerText=isMatch?"æ­£è§£!!":"ä¸æ­£è§£..."; m.style.color=isMatch?"#0f0":"#f00";
        document.getElementById('result-view').style.display='flex';
    }

    // --- ä¿å­˜ãƒ»åŒæœŸ ---
    function saveLocal() { localStorage.setItem('cm_v17_data', JSON.stringify({cards,levels,blank:blankData})); }
    function loadLocal() { const d=localStorage.getItem('cm_v17_data'); if(d){ const j=JSON.parse(d); cards=j.cards; levels=j.levels; blankData=j.blank;} }
    function resetData() { if(confirm("å…¨æ¶ˆå»?")) { localStorage.clear(); location.reload(); } }
    function downloadHTML() {
        let html = document.documentElement.outerHTML;
        const data = JSON.stringify({ cards, levels, blank: blankData });
        const tag = '\x3cscript id="embedded-data" type="application/json"\x3e' + data + '\x3c/script\x3e';
        html = html.replace(/<script id="embedded-data" type="application\/json">.*?<\/script>/i, tag);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], {type:"text/html"})); a.download = "index.html"; a.click();
    }
    function openSettings() { document.getElementById('settings-overlay').classList.add('open'); }
    function closeSettings() { document.getElementById('settings-overlay').classList.remove('open'); document.getElementById('edit-index').value="-1"; document.getElementById('add-btn').innerText="ï¼‹ è¿½åŠ "; }
    
    // PeerJS (çœç•¥å½¢)
    let peer=null;
    function startHost(){ if(typeof Peer==='undefined'){alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");return;} if(peer)peer.destroy(); peer=new Peer(); document.getElementById('sync-area').style.display='block'; document.getElementById('sync-msg').innerText="å¾…æ©Ÿä¸­..."; peer.on('open',id=>{ new QRCode(document.getElementById('qrcode'),{text:window.location.href.split('?')[0]+"?sync="+id,width:128,height:128});}); peer.on('connection',c=>{c.on('open',()=>c.send({cards,levels,blank:blankData}));});}
    function startClient(id){ if(peer)peer.destroy(); peer=new Peer(); peer.on('open',()=>{ const c=peer.connect(id); c.on('data',d=>{cards=d.cards;levels=d.levels;blankData=d.blank;saveLocal();renderUI();alert("åŒæœŸå®Œäº†");window.history.replaceState({},document.title,window.location.pathname);}); });}
</script>
</body>
</html>
