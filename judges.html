<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card Master V24 (ArUco Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/cv.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/aruco.js"></script>

    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        #canvas-container {
            position: relative; width: 100%; max-width: 640px; 
            background: #222; box-shadow: 0 0 20px rgba(0,255,0,0.2);
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        canvas { display: block; width: 100%; height: auto; }
        
        /* å†…éƒ¨å‡¦ç†ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆéè¡¨ç¤ºï¼‰ */
        #proc-canvas { display: none; }

        .game-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }
        
        button, .btn-float, .judge-btn { cursor: pointer; pointer-events: auto; }

        .btn-float { 
            background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #fff; 
            padding: 8px 15px; border-radius: 20px; font-size: 12px; margin: 10px; 
        }
        .btn-float:hover { background: rgba(255,255,255,0.2); }

        .judge-btn { 
            width: 80%; padding: 15px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 50px; 
            color: white; background: linear-gradient(to bottom, #28a745, #208030); 
            align-self: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #title-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #title-content { width: 90%; max-width: 500px; height: 80%; overflow-y: auto; text-align: center; }

        #controls { width: 90%; max-width: 600px; background: #222; padding: 10px; border-radius: 10px; margin-top: 10px; z-index: 5; }
        .slider-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        input[type=range] { width: 100%; cursor: grab; }

        #settings-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #151515; z-index: 200; transform: translateY(100%); 
            transition: transform 0.3s; padding: 20px; overflow-y: auto; box-sizing: border-box; 
        }
        #settings-overlay.open { transform: translateY(0); }
        .setting-box { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }
        h3 { margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 5px; font-size:1rem; color:#ddd; }

        .card-list { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; min-height: 80px;}
        .card-thumb { 
            min-width: 60px; height: 80px; background: #000; border: 1px solid #555; border-radius:4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .card-thumb img { width: 100%; height: 100%; object-fit: contain; }
        
        input[type="text"], select { 
            padding: 10px; width: 100%; margin-bottom: 5px; box-sizing: border-box; 
            background: #333; color: #fff; border: 1px solid #555; border-radius: 5px; 
        }

        .level-row {
            background: #333; padding: 10px; margin-bottom: 5px; border-radius: 6px; border: 1px solid #444;
            display: flex; flex-direction: column; cursor: default;
        }
        .level-row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .btn-mini { padding: 4px 8px; font-size: 11px; border-radius: 4px; border: none; margin-left: 5px; color: #fff;}
        .btn-edit { background: #007bff; } .btn-del { background: #dc3545; }

        #result-view { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.9); display: none; z-index: 400; 
            flex-direction: column; justify-content: center; align-items: center; cursor: pointer;
        }
        #status-msg { 
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
            background: rgba(40,167,69,0.95); padding: 8px 20px; border-radius: 20px; 
            font-size:12px; opacity:0; transition:opacity 0.5s; z-index:300; pointer-events: none;
        }
        #ar-guide-msg {
            position: absolute; top:50%; left:50%; transform:translate(-50%, -50%);
            color: #ff0; font-weight: bold; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px;
            pointer-events: none; text-align: center; display: none; line-height: 1.6; width: 80%;
        }
        
        video { display: none; }
    </style>
</head>
<body>

<div id="title-screen">
    <div id="title-content">
        <h1 style="text-shadow:0 0 10px #000; margin-bottom:10px;">CARD MASTER</h1>
        <p style="font-size:12px; color:#ccc; margin-bottom:20px;">å•é¡Œã‚’é¸æŠã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</p>
        <div id="title-level-list"></div>
        <div style="margin-top:30px;">
            <button class="btn-float" onclick="openSettings()">âš™ï¸ è¨­å®šãƒ»ã‚«ãƒ¼ãƒ‰ç™»éŒ²</button>
        </div>
    </div>
</div>

<div id="canvas-container">
    <canvas id="main-canvas"></canvas>
    <canvas id="proc-canvas"></canvas>
    
    <div id="ar-guide-msg">
        ğŸ“· èªè­˜å¾…æ©Ÿä¸­...<br>
        <span style="font-size:0.8em; font-weight:normal;">
        å››éš…ã« ArUcoãƒãƒ¼ã‚«ãƒ¼ ã‚’ç½®ã„ã¦ãã ã•ã„<br>
        (å·¦ä¸Š:0 / å³ä¸Š:1 / å³ä¸‹:2 / å·¦ä¸‹:3)
        </span>
    </div>

    <div class="game-ui" id="game-ui" style="display:none;">
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-float" onclick="startCam(true)">ğŸ“· å†èµ·å‹•</button>
            <button class="btn-float" onclick="goTitle()">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        </div>
        <div style="position:absolute; bottom:80px; left:10px;">
            <button class="btn-float" onclick="toggleViewMode()">ğŸ¨ è¡¨ç¤ºåˆ‡æ›¿</button>
        </div>
        <button id="btn-judge" class="judge-btn" onclick="judge()">åˆ¤ å®š !</button>
    </div>
</div>

<div id="controls">
    <div class="slider-row">
        <span>ç™½é»’æ„Ÿåº¦ <span id="val-thr">100</span></span>
        <span>åˆ¤å®šè¨±å®¹åº¦ <span id="val-tol">0.35</span></span>
    </div>
    <input type="range" min="10" max="250" value="100" oninput="updateParam('thr', this.value)">
    <input type="range" min="0.05" max="0.8" step="0.01" value="0.35" oninput="updateParam('tol', this.value)" style="margin-top:5px;">
    <div style="font-size:10px; color:#aaa; margin-top:5px; text-align:center;">
        æ„Ÿåº¦: å…‰ã®å¼·ã•ã«å¿œã˜ã¦èª¿æ•´ / è¨±å®¹åº¦: å³ã—ã• (å·¦:å³æ ¼ â‡„ å³:ç”˜ã„)
    </div>
</div>

<div id="status-msg"></div>
<video id="video-source" autoplay playsinline muted></video>

<div id="settings-overlay">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <h2>è¨­å®š</h2><button onclick="closeSettings()" class="btn-float" style="margin:0; background:#555;">é–‰ã˜ã‚‹</button>
    </div>
    
    <div class="setting-box">
        <h3>1. ãƒãƒ¼ã‚«ãƒ¼æº–å‚™ (å¿…é ˆ)</h3>
        <p style="font-size:12px; color:#ccc; line-height:1.5;">
            ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ŒArUcoãƒãƒ¼ã‚«ãƒ¼ã€ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
            ä»¥ä¸‹ã®IDã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒãƒƒãƒˆã®å››éš…ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚<br>
            <b>ID 0: å·¦ä¸Š</b> / <b>ID 1: å³ä¸Š</b><br>
            <b>ID 3: å·¦ä¸‹</b> / <b>ID 2: å³ä¸‹</b><br>
            <br>
            â€»ãƒãƒ¼ã‚«ãƒ¼ç”»åƒã¯ "ArUco Generator (Original)" ç­‰ã§æ¤œç´¢ã—ã¦å…¥æ‰‹ã—ã¦ãã ã•ã„ã€‚
        </p>
    </div>

    <div class="setting-box">
        <h3>2. ç”»åƒç™»éŒ²</h3>
        <p style="font-size:12px; color:#f88; margin-bottom:5px;">â€»ã‚«ãƒ¼ãƒ‰ã‚’çœŸæ­£é¢ã‹ã‚‰æ’®å½±ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„</p>
        <input type="text" id="reg-name" placeholder="ã‚«ãƒ¼ãƒ‰å (ä¾‹: A, ãƒ‰ãƒ©ã‚´ãƒ³)">
        <div style="background:#333; padding:8px; margin-bottom:10px; border-radius:4px;">
            <label style="cursor:pointer; display:flex; align-items:center;">
                <input type="checkbox" id="is-blank-check" style="width:20px; margin-right:5px;"> 
                ã“ã‚Œã‚’ã€Œç©ºç™½ã€ã¨ã—ã¦ç™»éŒ²ã™ã‚‹
            </label>
        </div>
        <label class="btn-float" style="display:block; text-align:center; margin:0; background:#007bff; border:none; font-size:14px; padding:12px;">
            ğŸ“ ç”»åƒã‚’é¸æŠã—ã¦ç™»éŒ²
            <input type="file" accept="image/*" onchange="registerImage(this)" style="display:none;">
        </label>
        <div class="card-list" id="reg-list"></div>
    </div>

    <div class="setting-box">
        <h3>3. å•é¡Œä½œæˆ</h3>
        <input type="hidden" id="edit-index" value="-1">
        <input type="text" id="lvl-name" placeholder="å•é¡Œã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: åˆç´š)">
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <select id="sel-0"></select><select id="sel-1"></select><select id="sel-2"></select><select id="sel-3"></select>
        </div>
        <button id="add-btn" onclick="addOrUpdateLevel()" style="width:100%; padding:12px; background:#28a745; color:#fff; border:none; border-radius:5px; font-weight:bold;">ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        <button id="cancel-btn" onclick="cancelEdit()" style="width:100%; padding:8px; background:#666; color:#fff; border:none; border-radius:5px; margin-top:5px; display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <div style="margin-top:15px; border-top:1px solid #444; padding-top:10px;">
            <div id="settings-level-list" class="level-list-container"></div>
        </div>
    </div>

    <div class="setting-box">
        <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
        <button onclick="downloadHTML()" style="width:100%; padding:10px; background:#007bff; color:#fff; border:none; border-radius:5px; margin-bottom:10px;">ğŸ’¾ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ (HTML)</button>
        <button onclick="startHost()" style="width:100%; padding:10px; background:#6610f2; color:#fff; border:none; border-radius:5px; margin-bottom:10px;">ğŸ“¡ QRåŒæœŸ (ãƒ›ã‚¹ãƒˆ)</button>
        <button onclick="resetData()" style="width:100%; padding:10px; background:#d00; color:#fff; border:none; border-radius:5px;">âš  å…¨å‰Šé™¤ (ãƒªã‚»ãƒƒãƒˆ)</button>
        <div id="sync-area" style="display:none; background:#fff; padding:10px; margin-top:10px; text-align:center; border-radius:8px;">
            <div id="qrcode"></div><div id="sync-msg" style="color:#000; font-size:11px;">å¾…æ©Ÿä¸­...</div>
        </div>
    </div>
</div>

<div id="result-view" onclick="this.style.display='none'">
    <div id="res-msg" style="font-size:4rem; font-weight:bold;"></div>
    <div style="font-size:1.2rem; opacity:0.8;">Tap to close</div>
</div>

<script id="embedded-data" type="application/json">null</script>

<script>
    // --- å®šæ•°è¨­å®š ---
    // å†…éƒ¨å‡¦ç†è§£åƒåº¦ (æ­ªã¿è£œæ­£å¾Œã®ã‚µã‚¤ã‚º)
    const MAT_W = 400; 
    const MAT_H = 280; 
    
    // ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾© (A4æ¨ªç›¸å½“ã«ãŠã‘ã‚‹æ¯”ç‡)
    // 63mm x 88mm ã‚«ãƒ¼ãƒ‰ã‚’4æšæ¨ªä¸¦ã³ã«ã™ã‚‹æƒ³å®š
    const CARD_ASPECT = 88 / 63;
    const CARD_W_RATIO = 0.16; // å…¨ä½“å¹…ã«å¯¾ã™ã‚‹ã‚«ãƒ¼ãƒ‰1æšã®å¹…
    const CARD_H_RATIO = CARD_W_RATIO * CARD_ASPECT * (MAT_W/MAT_H); 
    const GAP_RATIO = 0.05; // ã‚«ãƒ¼ãƒ‰é–“ã®éš™é–“
    
    // 4æšã®é…ç½®è¨ˆç®— (ä¸­å¤®å¯„ã›)
    const TOTAL_W_RATIO = (CARD_W_RATIO * 4) + (GAP_RATIO * 3);
    const START_X = (1.0 - TOTAL_W_RATIO) / 2;
    const START_Y = 0.35; // ç¸¦ä½ç½® (ä¸Šã‹ã‚‰35%ã®ä½ç½®)

    const SLOTS = [];
    for(let i=0; i<4; i++){
        SLOTS.push({
            x: START_X + i*(CARD_W_RATIO + GAP_RATIO),
            y: START_Y,
            w: CARD_W_RATIO,
            h: CARD_H_RATIO
        });
    }

    // --- å¤‰æ•° ---
    let cards=[], levels=[], blankData=null;
    let currentOrder=[], detected=["","","",""];
    let currentTarget=[];
    let isGameMode = false;
    let threshold = 100; // äºŒå€¤åŒ–ã®é–¾å€¤
    let tolerance = 0.35; // åˆ¤å®šã®å³ã—ã• (ä½ã„ã»ã©å³ã—ã„)
    let showBinarized = false;
    let detector = null;

    // DOM Elements
    const video = document.getElementById('video-source');
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const procCanvas = document.getElementById('proc-canvas');
    const procCtx = procCanvas.getContext('2d');
    const guideMsg = document.getElementById('ar-guide-msg');

    // åˆæœŸåŒ–
    window.onload = () => {
        // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
        try {
            const txt = document.getElementById('embedded-data').textContent;
            if(txt && txt!=="null") { const d=JSON.parse(txt); cards=d.cards; levels=d.levels; blankData=d.blank; }
            else loadLocal();
        } catch(e){ loadLocal(); }
        
        // å†…éƒ¨Canvasã‚µã‚¤ã‚ºè¨­å®š
        procCanvas.width = MAT_W; procCanvas.height = MAT_H;
        
        renderUI();
        startCam();
        
        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¾©å…ƒ
        updateParam('thr', threshold);
        updateParam('tol', tolerance);

        // åŒæœŸèµ·å‹•ãƒã‚§ãƒƒã‚¯
        const u = new URLSearchParams(window.location.search);
        if(u.get('sync')) startClient(u.get('sync'));
        
        // ARæ¤œå‡ºå™¨ (Original ArUco)
        if(typeof AR !== 'undefined') detector = new AR.Detector();
    };

    function updateParam(type, val) {
        if(type==='thr') { threshold=parseInt(val); document.getElementById('val-thr').innerText=threshold; }
        if(type==='tol') { tolerance=parseFloat(val); document.getElementById('val-tol').innerText=parseFloat(val).toFixed(2); }
    }
    function toggleViewMode() { showBinarized = !showBinarized; showToast(showBinarized ? "äºŒå€¤åŒ–ç”»åƒã‚’è¡¨ç¤º" : "é€šå¸¸è¡¨ç¤º"); }

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    async function startCam(manual=false) {
        if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
        
        const constraints = {
            video: { 
                facingMode: "environment", 
                width: { ideal: 1280 }, 
                height: { ideal: 720 } 
            }
        };

        try {
            const s = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = s;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                video.play(); requestAnimationFrame(loop);
            };
            if(manual) showToast("ã‚«ãƒ¡ãƒ©ã‚’å†èµ·å‹•ã—ã¾ã—ãŸ");
        } catch(e) {
            alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ»HTTPSæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„\nãƒ»ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„");
        }
    }

    // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
    function loop() {
        if(video.readyState !== 4) { requestAnimationFrame(loop); return; }
        
        // UIçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        const isTitle = document.getElementById('title-screen').style.display !== 'none';
        const isSettings = document.getElementById('settings-overlay').classList.contains('open');
        if(isTitle && !isSettings) {
            // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã§ã‚‚è£ã§ã‚«ãƒ¡ãƒ©ã¯å‹•ã‹ã™ãŒå‡¦ç†ã¯ã—ãªã„
            requestAnimationFrame(loop); return; 
        }

        // 1. æç”»
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // 2. ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º
        let corners = [null, null, null, null]; // ID:0,1,2,3
        if(detector) {
            const markers = detector.detect(imgData);
            markers.forEach(m => {
                if(m.id >= 0 && m.id <= 3) corners[m.id] = m.corners;
            });
        }

        // 3. ãƒãƒ¼ã‚«ãƒ¼æƒã„åˆ¤å®š
        const allFound = corners[0] && corners[1] && corners[2] && corners[3];
        guideMsg.style.display = (!allFound) ? 'block' : 'none';

        if(allFound) {
            // --- è£œæ­£ã¨åˆ¤å®š ---
            
            // ãƒãƒ¼ã‚«ãƒ¼ã®ä¸­å¿ƒåº§æ¨™ã‚’ç®—å‡º
            const centers = corners.map(c => {
                let sx=0, sy=0; c.forEach(p=>{sx+=p.x; sy+=p.y;});
                return {x:sx/4, y:sy/4};
            });

            // ãƒ›ãƒ¢ã‚°ãƒ©ãƒ•ã‚£å¤‰æ›ã®ãŸã‚ã®åº§æ¨™ãƒšã‚¢
            // Src: ã‚«ãƒ¡ãƒ©ç”»åƒä¸Šã®4ç‚¹ (TL, TR, BR, BL) â€»é †åºé‡è¦
            // ArUcoã®é…ç½®: 0(TL), 1(TR), 2(BR), 3(BL)
            const srcPoints = [
                centers[0].x, centers[0].y,
                centers[1].x, centers[1].y,
                centers[2].x, centers[2].y,
                centers[3].x, centers[3].y
            ];
            // Dst: è£œæ­£å¾Œ(procCanvas)ã®4éš…
            const dstPoints = [
                0, 0,           // TL
                MAT_W, 0,       // TR
                MAT_W, MAT_H,   // BR
                0, MAT_H        // BL
            ];

            // è¡Œåˆ—è¨ˆç®— & ç”»åƒå¤‰æ›(Warp)
            const H = getHomography(srcPoints, dstPoints);
            warpImage(imgData, procCtx, H);

            // è£œæ­£ç”»åƒã®äºŒå€¤åŒ–
            const procData = procCtx.getImageData(0,0,MAT_W, MAT_H);
            const bin = binarize(procData);

            // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º (äºŒå€¤åŒ–ãƒ¢ãƒ¼ãƒ‰æ™‚)
            if(showBinarized) {
                procCtx.putImageData(bin, 0, 0);
                // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®å·¦ä¸Šã«ãƒ¯ã‚¤ãƒ—è¡¨ç¤º
                ctx.drawImage(procCanvas, 10, 10, 160, 112);
                ctx.lineWidth=2; ctx.strokeStyle="red"; ctx.strokeRect(10,10,160,112);
            }

            // ã‚«ãƒ¼ãƒ‰åˆ¤å®šå‡¦ç†
            let detectedNow = [];
            ctx.lineWidth = 3; ctx.font = "bold 20px sans-serif";
            ctx.textAlign = "center";

            // ç·‘è‰²ã®æ ç·šã‚’æç”» (èªè­˜ä¸­ã‚µã‚¤ãƒ³)
            ctx.strokeStyle = "#00ff00";
            ctx.beginPath();
            ctx.moveTo(centers[0].x, centers[0].y); ctx.lineTo(centers[1].x, centers[1].y);
            ctx.lineTo(centers[2].x, centers[2].y); ctx.lineTo(centers[3].x, centers[3].y);
            ctx.closePath(); ctx.stroke();

            // å„ã‚¹ãƒ­ãƒƒãƒˆã®å‡¦ç†
            for(let i=0; i<4; i++) {
                const s = SLOTS[i];
                // å†…éƒ¨åº§æ¨™
                const tx = Math.floor(s.x * MAT_W);
                const ty = Math.floor(s.y * MAT_H);
                const tw = Math.floor(s.w * MAT_W);
                const th = Math.floor(s.h * MAT_H);

                // ç‰¹å¾´é‡å–å¾—
                const feat = getFeature(bin, tx, ty, tw, th, MAT_W);

                // ãƒãƒƒãƒãƒ³ã‚°
                let bestName = "?"; let minDiff = 1.0;
                
                // ç™»éŒ²ã‚«ãƒ¼ãƒ‰ã¨æ¯”è¼ƒ
                cards.forEach(c => {
                    if(c.isBlank) return;
                    const diff = compareShift(feat, c.data, tw, th, 4);
                    if(diff < minDiff) { minDiff = diff; bestName = c.name; }
                });
                
                // ç©ºç™½ã¨æ¯”è¼ƒ
                if(blankData) {
                    const bDiff = compareShift(feat, blankData, tw, th, 4);
                    if(bDiff < minDiff) { minDiff = bDiff; bestName = ""; } // ç©ºç™½åˆ¤å®š
                }

                // é–¾å€¤ãƒã‚§ãƒƒã‚¯
                if(minDiff > tolerance) bestName = "?";
                detectedNow.push(bestName);

                // --- ç”»é¢ã¸ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ---
                // ã‚¹ãƒ­ãƒƒãƒˆæ ã®æç”» (æ­ªã¿ã‚’è€ƒæ…®ã—ã¦åº§æ¨™å¤‰æ›)
                ctx.strokeStyle = (bestName !== "?") ? "cyan" : "rgba(255,255,255,0.3)";
                drawSlotOutline(ctx, s, corners);

                // æ–‡å­—è¡¨ç¤º
                const centerP = mapPoint(s.x + s.w/2, s.y + s.h/2, corners);
                
                ctx.fillStyle = "white";
                ctx.shadowColor="black"; ctx.shadowBlur=4; 
                ctx.fillText(bestName || "", centerP.x, centerP.y);
                ctx.shadowBlur=0;
                
                // ä¸€è‡´ç‡ (ãƒ‡ãƒãƒƒã‚°ç”¨)
                // ctx.font="10px sans-serif"; ctx.fillText(minDiff.toFixed(2), centerP.x, centerP.y+15);
            }
            detected = detectedNow;
        }

        requestAnimationFrame(loop);
    }

    // --- ç”»åƒå‡¦ç†ãƒ»è¨ˆç®—é–¢æ•° ---

    // åº§æ¨™è£œé–“ (å¹³é¢â†’ç”»é¢)
    function mapPoint(px, py, corners) {
        // corners: 0(TL), 1(TR), 2(BR), 3(BL)
        // ä¸Šè¾ºã®ç‚¹
        const tx = corners[0][0].x + (corners[1][1].x - corners[0][0].x) * px;
        const ty = corners[0][0].y + (corners[1][1].y - corners[0][0].y) * px;
        // ä¸‹è¾ºã®ç‚¹
        const bx = corners[3][3].x + (corners[2][2].x - corners[3][3].x) * px;
        const by = corners[3][3].y + (corners[2][2].y - corners[3][3].y) * px;
        // ä¸Šä¸‹ã‚’çµã‚“ã§Yæ¯”ç‡ã§ç‚¹æ±ºå®š
        return {
            x: tx + (bx - tx) * py,
            y: ty + (by - ty) * py
        };
    }

    function drawSlotOutline(ctx, s, corners) {
        const p1 = mapPoint(s.x, s.y, corners);
        const p2 = mapPoint(s.x+s.w, s.y, corners);
        const p3 = mapPoint(s.x+s.w, s.y+s.h, corners);
        const p4 = mapPoint(s.x, s.y+s.h, corners);
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        ctx.lineTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y);
        ctx.closePath(); ctx.stroke();
    }

    // ãƒ›ãƒ¢ã‚°ãƒ©ãƒ•ã‚£è¡Œåˆ—è¨ˆç®— (4ç‚¹å¯¾å¿œ)
    function getHomography(src, dst) {
        let A = [], B = [];
        for(let i=0; i<4; i++) {
            let sx=src[i*2], sy=src[i*2+1], dx=dst[i*2], dy=dst[i*2+1];
            A.push([sx, sy, 1, 0, 0, 0, -sx*dx, -sy*dx]);
            A.push([0, 0, 0, sx, sy, 1, -sx*dy, -sy*dy]);
            B.push(dx); B.push(dy);
        }
        const x = solveGaussian(A, B);
        return [x[0],x[1],x[2],x[3],x[4],x[5],x[6],x[7],1.0];
    }
    // ã‚¬ã‚¦ã‚¹ã®æ¶ˆå»æ³•
    function solveGaussian(A, B) {
        let n=A.length;
        for(let i=0; i<n; i++){
            let maxEl=Math.abs(A[i][i]), maxRow=i;
            for(let k=i+1; k<n; k++) if(Math.abs(A[k][i])>maxEl){maxEl=Math.abs(A[k][i]); maxRow=k;}
            for(let k=i; k<n; k++){let tmp=A[maxRow][k]; A[maxRow][k]=A[i][k]; A[i][k]=tmp;}
            let tmp=B[maxRow]; B[maxRow]=B[i]; B[i]=tmp;
            for(let k=i+1; k<n; k++){
                let c=-A[k][i]/A[i][i];
                for(let j=i; j<n; j++) if(i==j) A[k][j]=0; else A[k][j]+=c*A[i][j];
                B[k]+=c*B[i];
            }
        }
        let x=new Array(n);
        for(let i=n-1; i>-1; i--){
            let sum=0; for(let j=i+1; j<n; j++) sum+=A[i][j]*x[j];
            x[i]=(B[i]-sum)/A[i][i];
        }
        return x;
    }
    // é€†è¡Œåˆ— (3x3)
    function invertMatrix(m) {
        const n11=m[0], n12=m[1], n13=m[2], n21=m[3], n22=m[4], n23=m[5], n31=m[6], n32=m[7], n33=m[8];
        const t11=n33*n22-n32*n23, t12=n32*n13-n33*n12, t13=n23*n12-n22*n13;
        const det=n11*t11+n21*t12+n31*t13;
        if(det===0)return m;
        const idet=1/det;
        return [
            t11*idet, (n31*n23-n33*n21)*idet, (n32*n21-n31*n22)*idet,
            t12*idet, (n33*n11-n31*n13)*idet, (n31*n12-n32*n11)*idet,
            t13*idet, (n21*n13-n23*n11)*idet, (n22*n11-n21*n12)*idet
        ];
    }
    // ç”»åƒå¤‰å½¢ (Perspective Warp)
    function warpImage(src, ctxDst, H) {
        const w=ctxDst.canvas.width, h=ctxDst.canvas.height;
        const dstD=ctxDst.createImageData(w,h), dd=dstD.data;
        const srcD=src.data, sw=src.width, sh=src.height;
        const Hi = invertMatrix(H);
        
        for(let y=0; y<h; y++){
            for(let x=0; x<w; x++){
                const u = Hi[0]*x + Hi[1]*y + Hi[2];
                const v = Hi[3]*x + Hi[4]*y + Hi[5];
                const s = Hi[6]*x + Hi[7]*y + Hi[8];
                const sx = Math.floor(u/s), sy = Math.floor(v/s);
                const di = (y*w+x)*4;
                if(sx>=0 && sx<sw && sy>=0 && sy<sh){
                    const si = (sy*sw+sx)*4;
                    dd[di]=srcD[si]; dd[di+1]=srcD[si+1]; dd[di+2]=srcD[si+2]; dd[di+3]=255;
                } else {
                    dd[di+3]=0;
                }
            }
        }
        ctxDst.putImageData(dstD, 0, 0);
    }

    // äºŒå€¤åŒ–
    function binarize(img) {
        const d = img.data, w=img.width, h=img.height;
        const bin = new ImageData(w,h); const bd = bin.data;
        for(let i=0; i<d.length; i+=4) {
            const avg = (d[i]+d[i+1]+d[i+2])/3;
            const val = avg < threshold ? 0 : 255;
            bd[i]=bd[i+1]=bd[i+2]=val; bd[i+3]=255;
        }
        return bin;
    }
    // ç‰¹å¾´æŠ½å‡º (ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°)
    function getFeature(bin, x, y, w, h, strideW) {
        const p = []; const d = bin.data; const step = 3; // é«˜é€ŸåŒ–ã®ãŸã‚ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¤§ãã
        for(let py=0; py<h; py+=step) {
            for(let px=0; px<w; px+=step) {
                const idx = ((y+py)*strideW + (x+px)) * 4;
                p.push(d[idx]===0 ? 1 : 0); // é»’=1, ç™½=0
            }
        }
        return p;
    }
    // æ¯”è¼ƒé–¢æ•° (ã‚ºãƒ¬è¨±å®¹)
    function compareShift(a, b, w, h, shift) {
        if(!a || !b || a.length!==b.length) return 1.0;
        let minDiff = 1.0;
        // ã‚»ãƒ³ã‚¿ãƒ¼ã€å·¦å³ã€ä¸Šä¸‹ã®ã‚ºãƒ¬ã‚’è¨±å®¹ã—ã¦æ¯”è¼ƒ
        const offsets = [0, -1, 1]; 
        // ç°¡æ˜“æ¯”è¼ƒã®ãŸã‚ãƒ«ãƒ¼ãƒ—ã‚’å‰Šæ¸›
        let diff = 0, count = 0;
        for(let i=0; i<a.length; i++) {
            if(a[i] !== b[i]) diff++;
            count++;
        }
        return count===0 ? 1.0 : diff/count;
    }

    // --- ãã®ä»–UIæ©Ÿèƒ½ ---
    function registerImage(input) {
        if(!input.files[0]) return;
        const name = document.getElementById('reg-name').value || "Card"+(cards.length+1);
        const isBlank = document.getElementById('is-blank-check').checked;
        const r = new FileReader();
        r.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                // ç™»éŒ²ç”¨è§£åƒåº¦ (å†…éƒ¨å‡¦ç†ã«åˆã‚ã›ã‚‹)
                const tw = Math.floor(MAT_W * CARD_W_RATIO);
                const th = Math.floor(MAT_H * CARD_H_RATIO);
                c.width = tw; c.height = th;
                const tx = c.getContext('2d');
                tx.drawImage(img, 0, 0, tw, th);
                
                const b = binarize(tx.getImageData(0,0,tw,th));
                const data = getFeature(b, 0, 0, tw, th, tw); // ç‰¹å¾´æŠ½å‡º
                tx.putImageData(b, 0, 0); // ã‚µãƒ ãƒã‚¤ãƒ«ã¯äºŒå€¤åŒ–å¾Œã‚’ä½¿ç”¨
                const thumb = c.toDataURL();

                if(isBlank) {
                    blankData = data;
                    cards = cards.filter(x=>!x.isBlank);
                    cards.unshift({name:"ã€ç©ºç™½ã€‘"+name, data, thumb, isBlank:true});
                    showToast("ç©ºç™½ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ");
                } else {
                    cards.push({name, data, thumb, isBlank:false});
                    showToast("ç™»éŒ²ã—ã¾ã—ãŸ");
                }
                saveLocal(); renderUI();
                input.value=""; document.getElementById('reg-name').value=""; document.getElementById('is-blank-check').checked=false;
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(input.files[0]);
    }
    
    function addOrUpdateLevel() {
        const t = document.getElementById('lvl-name').value || "ç„¡é¡Œ";
        const o = [0,1,2,3].map(i => document.getElementById(`sel-${i}`).value);
        const idx = parseInt(document.getElementById('edit-index').value);
        if(idx>=0) { levels[idx]={title:t, order:o}; showToast("æ›´æ–°ã—ã¾ã—ãŸ"); }
        else { levels.push({title:t, order:o}); showToast("è¿½åŠ ã—ã¾ã—ãŸ"); }
        cancelEdit(); saveLocal(); renderUI();
    }
    function editLevel(i) {
        const l=levels[i]; document.getElementById('lvl-name').value=l.title;
        for(let j=0;j<4;j++) document.getElementById(`sel-${j}`).value=l.order[j];
        document.getElementById('edit-index').value=i;
        document.getElementById('add-btn').innerText="æ›´æ–°"; document.getElementById('cancel-btn').style.display="inline-block";
    }
    function cancelEdit() {
        document.getElementById('lvl-name').value=""; for(let j=0;j<4;j++) document.getElementById(`sel-${j}`).value="";
        document.getElementById('edit-index').value="-1"; document.getElementById('add-btn').innerText="ï¼‹ è¿½åŠ "; document.getElementById('cancel-btn').style.display="none";
    }
    function renderUI() {
        const cl = document.getElementById('reg-list'); cl.innerHTML="";
        cards.forEach((c,i)=>{
            const style = c.isBlank ? "border:2px dashed #0f0;" : "";
            cl.innerHTML+=`<div class="card-thumb" style="${style}"><img src="${c.thumb}"><div style="font-size:10px;overflow:hidden;width:100%;">${c.name}</div><div style="position:absolute;top:0;right:0;background:red;width:20px;color:white;text-align:center;cursor:pointer;" onclick="if(confirm('å‰Šé™¤?')){cards.splice(${i},1);if(c.isBlank)blankData=null;saveLocal();renderUI();}">Ã—</div></div>`;
        });
        for(let i=0;i<4;i++){
            const s=document.getElementById(`sel-${i}`); const v=s.value; s.innerHTML="<option value=''>- ç©ºç™½ -</option>";
            cards.forEach(c=>{ if(!c.isBlank) s.innerHTML+=`<option value='${c.name}'>${c.name}</option>`; });
            s.value=v;
        }
        const tl = document.getElementById('title-level-list'); tl.innerHTML="";
        if(levels.length===0) tl.innerHTML="<div style='color:#777;margin-top:20px;'>â€»å³ä¸Šã®è¨­å®šâš™ï¸ã‹ã‚‰å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„</div>";
        levels.forEach((l,i)=>{
            tl.innerHTML+=`<div style="background:rgba(255,255,255,0.1); padding:15px; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; border:1px solid #555;" onclick="startGame(${i})"><span style="font-weight:bold; font-size:16px;">${l.title}</span><span style="background:#007bff; padding:5px 10px; border-radius:15px; font-size:12px;">æŒ‘æˆ¦ â–¶</span></div>`;
        });
        const sl = document.getElementById('settings-level-list'); sl.innerHTML="";
        levels.forEach((l,i)=>{
            const detail = l.order.map(n=>n===""?"_":n).join(", ");
            sl.innerHTML+=`<div class="level-row"><div class="level-row-header"><span style="font-weight:bold;">${l.title}</span><div><button class="btn-mini btn-edit" onclick="editLevel(${i})">ç·¨é›†</button><button class="btn-mini btn-del" onclick="if(confirm('å‰Šé™¤?')){levels.splice(${i},1);saveLocal();renderUI();}">å‰Šé™¤</button></div></div><div style="font-size:11px;color:#aaa;">æ­£è§£: ${detail}</div></div>`;
        });
    }

    function startGame(i) { currentTarget=levels[i].order; isGameMode=true; document.getElementById('title-screen').style.display = 'none'; document.getElementById('game-ui').style.display = 'flex'; }
    function goTitle() { isGameMode=false; document.getElementById('title-screen').style.display = 'flex'; document.getElementById('game-ui').style.display = 'none'; }
    function judge() { 
        const isMatch = JSON.stringify(detected) === JSON.stringify(currentTarget); 
        const m = document.getElementById('res-msg'); m.innerText=isMatch?"æ­£è§£!!":"ä¸æ­£è§£..."; m.style.color=isMatch?"#0f0":"#f00";
        document.getElementById('result-view').style.display='flex';
    }

    function saveLocal() { localStorage.setItem('cm_v24_data', JSON.stringify({cards,levels,blank:blankData})); }
    function loadLocal() { const d=localStorage.getItem('cm_v24_data'); if(d){ const j=JSON.parse(d); cards=j.cards; levels=j.levels; blankData=j.blank;} }
    function resetData() { if(confirm("å…¨æ¶ˆå»?")) { localStorage.clear(); location.reload(); } }
    function showToast(m) { const e=document.getElementById('status-msg'); e.innerText=m; e.style.opacity=1; setTimeout(()=>e.style.opacity=0,2000); }
    function openSettings() { document.getElementById('settings-overlay').classList.add('open'); }
    function closeSettings() { document.getElementById('settings-overlay').classList.remove('open'); cancelEdit(); }
    
    function downloadHTML() {
        let html = document.documentElement.outerHTML;
        const data = JSON.stringify({ cards, levels, blank: blankData });
        const tag = '\x3cscript id="embedded-data" type="application/json"\x3e' + data + '\x3c/script\x3e';
        html = html.replace(/<script id="embedded-data" type="application\/json">.*?<\/script>/i, tag);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], {type:"text/html"})); a.download = "card_master_v24.html"; a.click();
    }
    
    let peer=null;
    function startHost(){ if(typeof Peer==='undefined'){alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");return;} if(peer)peer.destroy(); peer=new Peer(); document.getElementById('sync-area').style.display='block'; document.getElementById('sync-msg').innerText="å¾…æ©Ÿä¸­..."; peer.on('open',id=>{ new QRCode(document.getElementById('qrcode'),{text:window.location.href.split('?')[0]+"?sync="+id,width:128,height:128});}); peer.on('connection',c=>{c.on('open',()=>c.send({cards,levels,blank:blankData}));});}
    function startClient(id){ if(peer)peer.destroy(); peer=new Peer(); peer.on('open',()=>{ const c=peer.connect(id); c.on('data',d=>{cards=d.cards;levels=d.levels;blankData=d.blank;saveLocal();renderUI();showToast("åŒæœŸå®Œäº†");window.history.replaceState({},document.title,window.location.pathname);}); });}
</script>
</body>
</html>
