<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card Master V33 (Marker Fix)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/cv.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/aruco.js"></script>

    <style>
        body { font-family: sans-serif; background: #111; color: #fff; margin: 0; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; }
        
        /* ç”»é¢ç®¡ç† */
        .screen { position: absolute; top:0; left:0; width:100%; height:100%; display:none; flex-direction:column; align-items:center; justify-content:center; background:#222; z-index:10; }
        
        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-screen { background: #000; }
        #canvas-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; object-fit: cover; }
        #proc-canvas { display: none; }

        /* UIã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 10px; box-sizing: border-box; z-index: 20; }
        button { pointer-events: auto; cursor: pointer; border: none; outline: none; }
        .btn-float { background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #aaa; padding: 8px 16px; border-radius: 20px; font-size: 14px; margin: 10px; }
        .judge-btn { width: 200px; padding: 15px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; color: white; background: linear-gradient(to bottom, #28a745, #208030); align-self: center; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        /* å°åˆ·ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (æ™®æ®µã¯éè¡¨ç¤º) */
        #print-section { 
            display: none; 
            background: white; color: black; 
            width: 100%; height: 100%; 
            position: absolute; top: 0; left: 0; z-index: 999;
            flex-direction: column; align-items: center; justify-content: flex-start;
            overflow-y: auto; padding: 20px; box-sizing: border-box;
        }
        .marker-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
        .marker-item { text-align: center; border: 1px solid #ddd; padding: 10px; }
        .marker-item img { width: 150px; height: 150px; image-rendering: pixelated; border: 1px solid #000; }
        
        /* è¨­å®šãƒ»ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ãƒªã‚¹ãƒˆ */
        #title-list { width: 90%; max-width: 400px; overflow-y: auto; max-height: 50vh; margin-top: 20px; }
        .level-item { background: #333; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #444; }
        
        #settings-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #151515; z-index: 300; transform: translateY(100%); transition: transform 0.3s; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        #settings-overlay.open { transform: translateY(0); }
        .setting-box { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }

        /* ãã®ä»– */
        .card-list { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; min-height: 80px;}
        .card-thumb { min-width: 60px; height: 80px; background: #000; border: 1px solid #555; position: relative; }
        .card-thumb img { width: 100%; height: 100%; object-fit: contain; }
        #status-msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(40,167,69,0.9); padding: 8px 20px; border-radius: 20px; font-size:14px; opacity:0; transition:opacity 0.5s; z-index:400; pointer-events: none; }
        #result-overlay { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); flex-direction:column; justify-content:center; align-items:center; z-index:200; }
        
        video { display: none; }

        /* å°åˆ·æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«: å°åˆ·ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã ã‘ã‚’è¡¨ç¤º */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex !important; background: white; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div id="title-screen" class="screen">
    <h1 style="margin-bottom:5px; text-shadow: 0 0 10px #0af;">CARD MASTER</h1>
    <p style="color:#aaa; font-size:12px;">V33 Marker Fixed</p>
    <div id="title-list"></div>
    <div style="margin-top:20px;">
        <button class="btn-float" onclick="openSettings()">âš™ï¸ è¨­å®šãƒ»åŒæœŸ</button>
        <button class="btn-float" style="background:#e0a800; color:black;" onclick="openPrintMode()">ğŸ–¨ï¸ ãƒãƒ¼ã‚«ãƒ¼å°åˆ·</button>
    </div>
</div>

<div id="game-screen" class="screen">
    <div id="canvas-container">
        <canvas id="main-canvas"></canvas>
        <canvas id="proc-canvas"></canvas>
    </div>
    <div class="ui-layer">
        <div style="display:flex; justify-content:space-between; padding:10px;">
            <button class="btn-float" onclick="goTitle()">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«</button>
            <button class="btn-float" onclick="toggleDebug()">ç¯„å›²: <span id="debug-val">100%</span></button>
        </div>
        <div style="text-align:center; margin-bottom:10px; pointer-events:auto;">
            <div style="background:rgba(0,0,0,0.6); display:inline-block; padding:5px 15px; border-radius:15px; font-size:12px;">
                ãƒãƒ¼ã‚«ãƒ¼(0,10,20,30)ã‚’å¯¾è§’ç·šã«é…ç½®
            </div><br>
            <button class="judge-btn" onclick="judge()">åˆ¤ å®š !</button>
        </div>
    </div>
    <div id="result-overlay">
        <div style="background:#333; padding:30px; border-radius:15px; text-align:center; width:80%; max-width:300px; pointer-events:auto;">
            <h2 id="res-msg" style="font-size:2.5rem; margin:0 0 20px 0;"></h2>
            <button onclick="document.getElementById('result-overlay').style.display='none'" style="background:#555; color:#fff; padding:10px 30px; border-radius:20px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<div id="print-section">
    <h2 style="color:black;">ArUco Markers (Original)</h2>
    <p style="color:black;">ID: 0, 10, 20, 30<br>â€»é»’ã„æ ã®å‘¨ã‚Šã®ç™½ã„ä½™ç™½ã‚‚æ®‹ã—ã¦åˆ‡ã‚Šå–ã£ã¦ãã ã•ã„ã€‚</p>
    <div class="marker-container">
        <div class="marker-item">ID: 0<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=0&size=200" alt="Marker 0"></div>
        <div class="marker-item">ID: 10<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=10&size=200" alt="Marker 10"></div>
        <div class="marker-item">ID: 20<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=20&size=200" alt="Marker 20"></div>
        <div class="marker-item">ID: 30<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=30&size=200" alt="Marker 30"></div>
    </div>
    <div class="no-print" style="margin-top:30px;">
        <button onclick="window.print()" style="padding:15px 30px; background:#007bff; color:white; font-size:18px; border-radius:8px;">ğŸ–¨ï¸ ã“ã®ãƒšãƒ¼ã‚¸ã‚’å°åˆ·ã™ã‚‹</button>
        <br><br>
        <button onclick="closePrintMode()" style="padding:10px 20px; background:#555; color:white; border-radius:5px;">æˆ»ã‚‹</button>
    </div>
</div>

<div id="settings-overlay">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <h2>è¨­å®šãƒ»ç™»éŒ²</h2><button onclick="closeSettings()" class="btn-float" style="margin:0; background:#555;">é–‰ã˜ã‚‹</button>
    </div>
    
    <div class="setting-box" style="border:1px solid #007bff;">
        <h3>ğŸ“¡ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
        <button onclick="startHost()" style="width:100%; padding:10px; background:#007bff; color:#fff; border-radius:5px;">QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</button>
        <div id="sync-area" style="display:none; background:#fff; padding:20px; margin-top:10px; text-align:center; border-radius:8px; color:#000;">
            <div id="qrcode" style="margin:10px auto;"></div>
            <div id="sync-msg" style="font-size:12px; color:#333;">æ¥ç¶šå¾…æ©Ÿä¸­...</div>
            <button onclick="document.getElementById('sync-area').style.display='none'" style="margin-top:10px; padding:5px 10px; background:#555; color:#fff; border-radius:4px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div class="setting-box">
        <h3>ã‚«ãƒ¼ãƒ‰ç™»éŒ²</h3>
        <input type="text" id="reg-name" placeholder="ã‚«ãƒ¼ãƒ‰å" style="width:100%; padding:10px; margin-bottom:5px; box-sizing:border-box;">
        <label style="display:flex; align-items:center; background:#333; padding:8px; margin-bottom:5px;">
            <input type="checkbox" id="is-blank-check" style="margin-right:10px;"> ç©ºç™½ã¨ã—ã¦ç™»éŒ²
        </label>
        <label style="display:block; text-align:center; background:#007bff; padding:10px; border-radius:5px; margin-top:5px;">
            ğŸ“ ç”»åƒã‚’é¸æŠ
            <input type="file" accept="image/*" onchange="registerImage(this)" style="display:none;">
        </label>
        <div class="card-list" id="reg-list" style="margin-top:10px;"></div>
    </div>

    <div class="setting-box">
        <h3>å•é¡Œä½œæˆ</h3>
        <input type="text" id="lvl-name" placeholder="å•é¡Œå" style="width:100%; padding:10px; margin-bottom:5px; box-sizing:border-box;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <div><span style="font-size:10px;">ID:0</span><select id="sel-0" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:10</span><select id="sel-10" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:20</span><select id="sel-20" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:30</span><select id="sel-30" style="width:100%;"></select></div>
        </div>
        <button onclick="addLevel()" style="width:100%; padding:10px; background:#28a745; color:#fff; border-radius:5px; margin-top:10px;">ï¼‹ è¿½åŠ </button>
        <div id="level-list" style="margin-top:10px;"></div>
    </div>
    
    <div class="setting-box"><button onclick="resetData()" style="width:100%; padding:10px; background:#d00; color:#fff; border-radius:5px;">âš  ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤</button></div>
</div>

<div id="status-msg"></div>
<video id="video-source" autoplay playsinline muted></video>

<script>
    const PROC_W=100, PROC_H=140; 
    const TARGET_IDS=[0,10,20,30];

    let cards=[], levels=[], blankData=null;
    let detectedInfo={}; let currentTarget=null;
    let marginScale=1.0; let detector=null; let videoStream=null; let isGameRunning=false;
    let peer=null;

    const video=document.getElementById('video-source');
    const canvas=document.getElementById('main-canvas');
    const ctx=canvas.getContext('2d');
    const procCanvas=document.getElementById('proc-canvas');
    const procCtx=procCanvas.getContext('2d');

    window.onload=()=>{
        loadData(); renderTitleList(); showScreen('title-screen');
        const u=new URLSearchParams(window.location.search);
        if(u.get('sync')){ openSettings(); startClient(u.get('sync')); }
    };

    function showScreen(id){
        document.querySelectorAll('.screen').forEach(el=>el.style.display='none');
        document.getElementById('print-section').style.display='none';
        document.getElementById(id).style.display='flex';
    }

    // --- å°åˆ·ãƒ¢ãƒ¼ãƒ‰ ---
    function openPrintMode(){
        document.querySelectorAll('.screen').forEach(el=>el.style.display='none');
        document.getElementById('print-section').style.display='flex';
    }
    function closePrintMode(){ showScreen('title-screen'); }

    // --- ã‚²ãƒ¼ãƒ  ---
    function startGame(idx){
        if(!levels[idx])return;
        currentTarget=levels[idx]; showScreen('game-screen');
        if(!isGameRunning){
            isGameRunning=true;
            if(typeof AR!=='undefined') detector=new AR.Detector();
            procCanvas.width=PROC_W; procCanvas.height=PROC_H;
            startCamera();
        }
        showToast("é–‹å§‹: "+currentTarget.title);
    }
    function goTitle(){ isGameRunning=false; stopCamera(); showScreen('title-screen'); }

    // --- ã‚«ãƒ¡ãƒ© ---
    async function startCamera(){
        try{
            const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}});
            videoStream=s; video.srcObject=s;
            video.onloadedmetadata=()=>{ canvas.width=video.videoWidth; canvas.height=video.videoHeight; requestAnimationFrame(loop); };
        }catch(e){ alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: "+e.message); goTitle(); }
    }
    function stopCamera(){ if(videoStream){videoStream.getTracks().forEach(t=>t.stop()); videoStream=null;} }

    let lastTime=0;
    function loop(ts){
        if(!isGameRunning)return; requestAnimationFrame(loop);
        if(ts-lastTime<33)return; lastTime=ts;
        if(video.readyState!==4)return;

        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
        let markers=[]; if(detector) markers=detector.detect(imgData);

        // IDåˆ¥ç®¡ç†
        let mById={}; TARGET_IDS.forEach(id=>mById[id]=[]);
        markers.forEach(m=>{ if(TARGET_IDS.includes(m.id)) mById[m.id].push(m); drawDebug(ctx,m); });

        detectedInfo={}; TARGET_IDS.forEach(id=>detectedInfo[id]={name:"?",score:0});

        TARGET_IDS.forEach(id=>{
            const ms=mById[id];
            if(ms.length===2){
                const c1=getCenter(ms[0].corners), c2=getCenter(ms[1].corners);
                const rect=getBoundingRect(c1,c2,marginScale);
                const pts=[rect.x,rect.y, rect.x+rect.w,rect.y, rect.x+rect.w,rect.y+rect.h, rect.x,rect.y+rect.h];
                const H=getHomography(pts,[0,0,PROC_W,0,PROC_W,PROC_H,0,PROC_H]);
                warpImage(imgData,procCtx,H);
                
                const bin=binarize(procCtx.getImageData(0,0,PROC_W,PROC_H));
                const feat=getFeature(bin,PROC_W,PROC_H);
                const res=identify(feat);
                
                detectedInfo[id]={name:res.name, score:res.score};
                drawResult(ctx,rect,id,res.name,res.score);
            }
        });
    }

    // --- æç”»ãƒ»åˆ¤å®š ---
    function drawDebug(ctx,m){
        ctx.strokeStyle="#0f0"; ctx.lineWidth=2; ctx.beginPath();
        m.corners.forEach((p,i)=>{i==0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y)}); ctx.closePath(); ctx.stroke();
    }
    function drawResult(ctx,r,id,name,score){
        ctx.strokeStyle="cyan"; ctx.lineWidth=3; ctx.strokeRect(r.x,r.y,r.w,r.h);
        ctx.fillStyle="cyan"; ctx.font="bold 12px sans-serif"; ctx.fillText(`ID:${id}`,r.x,r.y-5);
        const l=(name==="")?"ç©ºç™½":name; ctx.fillStyle=(name==="?")?"gray":"white"; 
        ctx.font="bold 20px sans-serif"; ctx.textAlign="center"; 
        ctx.shadowColor="black"; ctx.shadowBlur=3;
        ctx.fillText(l,r.x+r.w/2,r.y+r.h/2);
        ctx.font="10px sans-serif"; ctx.fillText(`${Math.floor(score*100)}%`,r.x+r.w/2,r.y+r.h/2+15);
        ctx.shadowBlur=0; ctx.textAlign="start";
    }
    function identify(feat){
        let best="?", minD=1.0;
        cards.forEach(c=>{if(!c.isBlank){const d=compare(feat,c.data);if(d<minD){minD=d;best=c.name;}}});
        if(blankData){const d=compare(feat,blankData);if(d<minD){minD=d;best="";}}
        const sc=1.0-minD; if(sc<0.6) best="?";
        return {name:best, score:sc};
    }
    function judge(){
        if(!currentTarget)return; let ok=true;
        TARGET_IDS.forEach((id,i)=>{ if(detectedInfo[id].name!==currentTarget.order[i]) ok=false; });
        const ov=document.getElementById('result-overlay'); ov.style.display='flex';
        const m=document.getElementById('res-msg'); m.innerText=ok?"æ­£è§£!! ğŸ‰":"ä¸æ­£è§£..."; m.style.color=ok?"#0f0":"#f55";
    }
    function toggleDebug(){ marginScale=(marginScale===1.0)?1.2:1.0; document.getElementById('debug-val').innerText=Math.round(marginScale*100)+"%"; }

    // --- è¨ˆç®— ---
    function getCenter(c){let x=0,y=0;c.forEach(p=>{x+=p.x;y+=p.y});return{x:x/4,y:y/4};}
    function getBoundingRect(p1,p2,s){const mx=Math.min(p1.x,p2.x),Mx=Math.max(p1.x,p2.x),my=Math.min(p1.y,p2.y),My=Math.max(p1.y,p2.y),w=Mx-mx,h=My-my,cx=mx+w/2,cy=my+h/2,nw=w*s,nh=h*s;return{x:cx-nw/2,y:cy-nh/2,w:nw,h:nh};}
    function getHomography(src,dst){let A=[],B=[];for(let i=0;i<4;i++){let sx=src[i*2],sy=src[i*2+1],dx=dst[i*2],dy=dst[i*2+1];A.push([sx,sy,1,0,0,0,-sx*dx,-sy*dx]);A.push([0,0,0,sx,sy,1,-sx*dy,-sy*dy]);B.push(dx);B.push(dy);}return solve(A,B).concat([1.0]);}
    function solve(A,B){let n=A.length,x=new Array(n);for(let i=0;i<n;i++){let m=Math.abs(A[i][i]),r=i;for(let k=i+1;k<n;k++)if(Math.abs(A[k][i])>m){m=Math.abs(A[k][i]);r=k}for(let k=i;k<n;k++){let t=A[r][k];A[r][k]=A[i][k];A[i][k]=t}let t=B[r];B[r]=B[i];B[i]=t;for(let k=i+1;k<n;k++){let c=-A[k][i]/A[i][i];for(let j=i;j<n;j++)if(i==j)A[k][j]=0;else A[k][j]+=c*A[i][j];B[k]+=c*B[i]}}for(let i=n-1;i>=0;i--){let s=0;for(let j=i+1;j<n;j++)s+=A[i][j]*x[j];x[i]=(B[i]-s)/A[i][i]}return x;}
    function invert(m){const n11=m[0],n12=m[1],n13=m[2],n21=m[3],n22=m[4],n23=m[5],n31=m[6],n32=m[7],n33=m[8],t11=n33*n22-n32*n23,t12=n32*n13-n33*n12,t13=n23*n12-n22*n13,det=n11*t11+n21*t12+n31*t13;if(det===0)return m;const i=1/det;return[t11*i,(n31*n23-n33*n21)*i,(n32*n21-n31*n22)*i,t12*i,(n33*n11-n31*n13)*i,(n31*n12-n32*n11)*i,t13*i,(n21*n13-n23*n11)*i,(n22*n11-n21*n12)*i];}
    function warpImage(src,dst,H){const w=dst.canvas.width,h=dst.canvas.height,dD=dst.createImageData(w,h),dd=dD.data,sD=src.data,sw=src.width,sh=src.height,Hi=invert(H);for(let y=0;y<h;y++)for(let x=0;x<w;x++){const u=Hi[0]*x+Hi[1]*y+Hi[2],v=Hi[3]*x+Hi[4]*y+Hi[5],s=Hi[6]*x+Hi[7]*y+Hi[8],sx=Math.floor(u/s),sy=Math.floor(v/s),di=(y*w+x)*4;if(sx>=0&&sx<sw&&sy>=0&&sy<sh){const si=(sy*sw+sx)*4;dd[di]=sD[si];dd[di+1]=sD[si+1];dd[di+2]=sD[si+2];dd[di+3]=255}else dd[di+3]=0}dst.putImageData(dD,0,0);}
    function binarize(d){const b=new ImageData(d.width,d.height),bd=b.data,dd=d.data;for(let i=0;i<dd.length;i+=4){const v=(dd[i]+dd[i+1]+dd[i+2])/3<100?0:255;bd[i]=bd[i+1]=bd[i+2]=v;bd[i+3]=255}return b;}
    function getFeature(b,w,h){const p=[],d=b.data,step=3;for(let y=0;y<h;y+=step)for(let x=0;x<w;x+=step)p.push(d[((y*w+x)*4)]===0?1:0);return p;}
    function compare(a,b){if(!a||!b||a.length!=b.length)return 1;let d=0,c=0;for(let i=0;i<a.length;i++){if(a[i]!=b[i])d++;c++}return c?d/c:1;}

    // --- åŒæœŸ ---
    function startHost(){
        if(typeof Peer==='undefined'){alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");return;} if(peer)peer.destroy();
        try{peer=new Peer();}catch(e){alert(e);return;}
        const a=document.getElementById('sync-area'),q=document.getElementById('qrcode'),m=document.getElementById('sync-msg');
        a.style.display='block'; q.innerHTML=""; m.innerText="æ¥ç¶šå¾…æ©Ÿä¸­...";
        peer.on('open',id=>{ new QRCode(q,{text:window.location.href.split('?')[0]+"?sync="+id,width:150,height:150}); });
        peer.on('error',e=>m.innerText="ã‚¨ãƒ©ãƒ¼:"+e.type);
        peer.on('connection',c=>{ m.innerText="æ¥ç¶š! é€ä¿¡ä¸­..."; c.on('open',()=>{ c.send({cards,levels,blankData}); setTimeout(()=>m.innerText="é€ä¿¡å®Œäº†!",500); }); });
    }
    function startClient(id){
        if(typeof Peer==='undefined')return; if(peer)peer.destroy(); peer=new Peer(); showToast("åŒæœŸä¸­...");
        peer.on('open',()=>{ const c=peer.connect(id); c.on('open',()=>showToast("ãƒ›ã‚¹ãƒˆæ¥ç¶š")); c.on('data',d=>{ if(d.cards){ cards=d.cards;levels=d.levels;blankData=d.blankData; saveData();renderTitleList(); showToast("å®Œäº†!"); window.history.replaceState({},document.title,window.location.pathname); } }); });
    }

    // --- ãƒ‡ãƒ¼ã‚¿/UI ---
    function saveData(){ localStorage.setItem('cm_v33',JSON.stringify({cards,levels,blankData})); }
    function loadData(){ const d=localStorage.getItem('cm_v33'); if(d){try{const j=JSON.parse(d);cards=j.cards||[];levels=j.levels||[];blankData=j.blankData}catch(e){}} }
    function resetData(){ if(confirm("æ¶ˆå»?")){localStorage.removeItem('cm_v33');location.reload();} }
    function registerImage(inp){
        if(!inp.files[0])return; const n=document.getElementById('reg-name').value||"C"+(cards.length+1), ib=document.getElementById('is-blank-check').checked;
        const r=new FileReader(); r.onload=e=>{
            const i=new Image(); i.onload=()=>{
                const c=document.createElement('canvas');c.width=PROC_W;c.height=PROC_H;const t=c.getContext('2d');t.drawImage(i,0,0,PROC_W,PROC_H);
                const b=binarize(t.getImageData(0,0,PROC_W,PROC_H)), f=getFeature(b,PROC_W,PROC_H);
                t.putImageData(b,0,0); const th=c.toDataURL(); const nc={name:n,data:f,thumb:th,isBlank:ib};
                if(ib){blankData=f;cards=cards.filter(x=>!x.isBlank);cards.unshift(nc)}else cards.push(nc);
                saveData(); renderTitleList(); inp.value=""; showToast("ç™»éŒ²:"+n);
            }; i.src=e.target.result;
        }; r.readAsDataURL(inp.files[0]);
    }
    function addLevel(){ const t=document.getElementById('lvl-name').value||"ç„¡é¡Œ", o=TARGET_IDS.map(id=>document.getElementById('sel-'+id).value); levels.push({title:t,order:o}); saveData(); renderTitleList(); document.getElementById('lvl-name').value=""; }
    function renderTitleList(){
        const tl=document.getElementById('title-list'), gl=document.getElementById('reg-list');
        if(!levels.length) tl.innerHTML="<div style='text-align:center;color:#777;margin:20px'>å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„</div>";
        else { tl.innerHTML=""; levels.forEach((l,i)=>tl.innerHTML+=`<div class="level-item" onclick="startGame(${i})"><span>${l.title}</span><span style="background:#0af;color:#000;padding:2px 8px;border-radius:10px;font-size:12px">æŒ‘æˆ¦</span></div>`); }
        gl.innerHTML=""; cards.forEach((c,i)=>gl.innerHTML+=`<div class="card-thumb" style="${c.isBlank?'border:2px dashed #0f0':''}"><img src="${c.thumb}"><div style="font-size:10px;text-align:center;overflow:hidden">${c.name}</div><div style="position:absolute;top:0;right:0;background:red;width:20px;text-align:center;cursor:pointer;color:white" onclick="if(confirm('å‰Šé™¤?')){cards.splice(${i},1);saveData();renderTitleList()}">Ã—</div></div>`);
        const ll=document.getElementById('level-list'); ll.innerHTML="";
        levels.forEach((l,i)=>ll.innerHTML+=`<div style="background:#333;padding:5px;margin:5px 0;border-radius:4px;display:flex;justify-content:space-between;border:1px solid #555"><div><b>${l.title}</b><div style="font-size:10px;color:#aaa">${l.order.join(', ')}</div></div><button style="background:#d00;color:white;padding:5px;border-radius:4px" onclick="if(confirm('å‰Šé™¤?')){levels.splice(${i},1);saveData();renderTitleList()}">å‰Šé™¤</button></div>`);
        TARGET_IDS.forEach(id=>{ const s=document.getElementById('sel-'+id); s.innerHTML="<option value=''>- ç©ºç™½ -</option>"; cards.forEach(c=>{if(!c.isBlank)s.innerHTML+=`<option value="${c.name}">${c.name}</option>`}); });
    }
    function showToast(m){const e=document.getElementById('status-msg');e.innerText=m;e.style.opacity=1;setTimeout(()=>e.style.opacity=0,2000);}
    function openSettings(){document.getElementById('settings-overlay').classList.add('open');}
    function closeSettings(){document.getElementById('settings-overlay').classList.remove('open');}
</script>
</body>
</html>
