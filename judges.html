<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card Master V29 (Stable)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/cv.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/aruco.js"></script>

    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        #canvas-container {
            position: relative; width: 100%; max-width: 640px; 
            background: #222; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        canvas { display: block; width: 100%; height: auto; }
        #proc-canvas { display: none; }

        .game-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }
        
        button, .btn-float, .judge-btn { cursor: pointer; pointer-events: auto; }
        .btn-float { 
            background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #fff; 
            padding: 8px 15px; border-radius: 20px; font-size: 12px; margin: 10px; 
        }
        .judge-btn { 
            width: 80%; padding: 15px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 50px; 
            color: white; background: linear-gradient(to bottom, #28a745, #208030); 
            align-self: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #ar-guide-msg {
            position: absolute; top:10px; left:50%; transform:translateX(-50%);
            color: #fff; font-size:12px; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px;
            pointer-events: none; text-align: center; width: 95%; line-height: 1.4;
        }

        #result-overlay {
            display:none; position:absolute; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.85); flex-direction:column; justify-content:center; align-items:center; z-index:50;
        }

        #controls { width: 90%; max-width: 600px; background: #222; padding: 10px; border-radius: 10px; margin-top: 10px; z-index: 5; }
        .slider-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        input[type=range] { width: 100%; cursor: grab; }

        /* è¨­å®šç”»é¢ */
        #settings-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #151515; z-index: 200; transform: translateY(100%); 
            transition: transform 0.3s; padding: 20px; overflow-y: auto; box-sizing: border-box; 
        }
        #settings-overlay.open { transform: translateY(0); }
        .setting-box { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }
        
        .card-list { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; min-height: 80px;}
        .card-thumb { 
            min-width: 60px; height: 80px; background: #000; border: 1px solid #555; border-radius:4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .card-thumb img { width: 100%; height: 100%; object-fit: contain; }
        .btn-mini { padding: 4px 8px; font-size: 11px; border-radius: 4px; border: none; margin-left: 5px; color: #fff;}
        .btn-edit { background: #007bff; } .btn-del { background: #dc3545; }
        
        #status-msg { 
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
            background: rgba(40,167,69,0.95); padding: 8px 20px; border-radius: 20px; 
            font-size:12px; opacity:0; transition:opacity 0.5s; z-index:300; pointer-events: none;
        }
        
        #sync-area {
            display:none; background:#fff; padding:20px; margin-top:10px; 
            text-align:center; border-radius:8px; color:#000;
        }
        #qrcode { margin: 10px auto; }
        
        video { display: none; }
    </style>
</head>
<body>

<div id="canvas-container">
    <canvas id="main-canvas"></canvas>
    <canvas id="proc-canvas"></canvas>
    
    <div id="ar-guide-msg">
        <b>ID: 0, 10, 20, 30 ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨</b><br>
        å¯¾è§’ç·šã«åŒã˜ãƒãƒ¼ã‚«ãƒ¼ã‚’2ã¤ç½®ãã¨èªè­˜ã—ã¾ã™
    </div>

    <div class="game-ui">
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-float" onclick="openSettings()">âš™ï¸ è¨­å®šãƒ»åŒæœŸ</button>
            <button class="btn-float" onclick="toggleDebug()">ç¯„å›²èª¿æ•´: <span id="debug-status">100%</span></button>
        </div>
        
        <div id="result-overlay" onclick="this.style.display='none'">
            <div id="res-msg" style="font-size:3rem; font-weight:bold;"></div>
            <div style="margin-top:20px; color:#ccc;">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</div>
        </div>

        <button id="btn-judge" class="judge-btn" onclick="judge()">åˆ¤ å®š !</button>
    </div>
</div>

<div id="controls">
    <div class="slider-row">
        <span>ç¯„å›²ã®åºƒãŒã‚Š <span id="val-margin">1.0</span></span>
        <span>ç™½é»’æ„Ÿåº¦ <span id="val-thr">100</span></span>
    </div>
    <input type="range" min="0.8" max="1.5" step="0.05" value="1.0" oninput="updateParam('margin', this.value)">
    <input type="range" min="10" max="250" value="100" oninput="updateParam('thr', this.value)" style="margin-top:5px;">
</div>

<div id="status-msg"></div>
<video id="video-source" autoplay playsinline muted></video>

<div id="settings-overlay">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <h2>è¨­å®šãƒ»ç™»éŒ²</h2><button onclick="closeSettings()" class="btn-float" style="margin:0; background:#555;">é–‰ã˜ã‚‹</button>
    </div>
    
    <div class="setting-box" style="border: 1px solid #aaa;">
        <h3>ğŸ–¨ï¸ ãƒãƒ¼ã‚«ãƒ¼æº–å‚™</h3>
        <p style="font-size:11px; color:#ccc;">ã“ã®ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®æ­£ã—ã„ãƒãƒ¼ã‚«ãƒ¼(0, 10, 20, 30)ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
        <button onclick="showMarkers()" style="width:100%; padding:10px; background:#e0a800; color:#000; border:none; border-radius:5px; font-weight:bold;">ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºãƒ»å°åˆ·</button>
    </div>

    <div class="setting-box" style="border: 2px solid #007bff;">
        <h3>ğŸ“¡ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
        <button onclick="startHost()" style="width:100%; padding:12px; background:#007bff; color:#fff; border:none; border-radius:5px; font-weight:bold;">QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º (PCå´)</button>
        <div id="sync-area">
            <div style="font-weight:bold; margin-bottom:5px;">ã‚¹ãƒãƒ›ã§èª­ã¿å–ã£ã¦ãã ã•ã„</div>
            <div id="qrcode"></div>
            <div id="sync-msg" style="font-size:12px;">æ¥ç¶šå¾…æ©Ÿä¸­...</div>
            <button onclick="document.getElementById('sync-area').style.display='none'" style="margin-top:10px; padding:5px 10px; background:#555; color:#fff; border:none; border-radius:4px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div class="setting-box">
        <h3>1. ç”»åƒç™»éŒ²</h3>
        <input type="text" id="reg-name" placeholder="ã‚«ãƒ¼ãƒ‰å" style="width:100%; padding:10px; margin-bottom:5px; box-sizing:border-box;">
        <div style="background:#333; padding:8px; margin-bottom:10px; border-radius:4px;">
            <label style="cursor:pointer; display:flex; align-items:center;">
                <input type="checkbox" id="is-blank-check" style="width:20px; margin-right:5px;"> ç©ºç™½ã¨ã—ã¦ç™»éŒ²
            </label>
        </div>
        <label class="btn-float" style="display:block; text-align:center; margin:0; background:#007bff; border:none; font-size:14px; padding:12px;">
            ğŸ“ ç”»åƒã‚’é¸æŠ
            <input type="file" accept="image/*" onchange="registerImage(this)" style="display:none;">
        </label>
        <div class="card-list" id="reg-list" style="margin-top:10px;"></div>
    </div>

    <div class="setting-box">
        <h3>2. æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
        <input type="text" id="lvl-name" placeholder="å•é¡Œå" style="width:100%; padding:10px; margin-bottom:5px; box-sizing:border-box;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
            <div><span style="font-size:10px;">ID:0</span><select id="sel-0" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:10</span><select id="sel-10" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:20</span><select id="sel-20" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:30</span><select id="sel-30" style="width:100%;"></select></div>
        </div>
        <button onclick="addLevel()" style="width:100%; padding:10px; background:#28a745; color:#fff; border:none; border-radius:5px;">ï¼‹ è¿½åŠ </button>
        <div id="level-list" style="margin-top:10px;"></div>
    </div>
    
    <div class="setting-box"><button onclick="resetData()" style="width:100%; padding:10px; background:#d00; color:#fff; border:none; border-radius:5px;">âš  ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤</button></div>
</div>

<script>
    // --- å®šæ•° ---
    const PROC_W = 100;
    const PROC_H = 140;
    // ä»Šå›ä½¿ç”¨ã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ID
    const TARGET_IDS = [0, 10, 20, 30];

    // --- å¤‰æ•° ---
    let cards = [];
    let levels = [];
    let blankData = null;
    let detectedNames = {}; // IDã”ã¨ã®çµæœ {0:"A", 10:"B"...}
    TARGET_IDS.forEach(id => detectedNames[id] = "?");

    let currentTarget = [];
    let threshold = 100;
    let marginScale = 1.0;
    let detector = null;
    let peer = null;

    // DOM
    const video = document.getElementById('video-source');
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const procCanvas = document.getElementById('proc-canvas');
    const procCtx = procCanvas.getContext('2d');

    window.onload = () => {
        loadData(); 
        renderUI(); 
        startCamera(); // ã‚«ãƒ¡ãƒ©èµ·å‹•
        // js-arucoåˆæœŸåŒ– (Original Dictionary)
        if(typeof AR !== 'undefined') detector = new AR.Detector();
        procCanvas.width = PROC_W; procCanvas.height = PROC_H;

        const u = new URLSearchParams(window.location.search);
        if(u.get('sync')) startClient(u.get('sync'));
    };

    function updateParam(k, v) {
        if(k==='thr') { threshold=parseInt(v); document.getElementById('val-thr').innerText=v; }
        if(k==='margin') { marginScale=parseFloat(v); document.getElementById('debug-status').innerText=Math.round(marginScale*100)+"%"; }
    }
    function toggleDebug() { marginScale = (marginScale===1.0)?1.2:1.0; document.getElementById('debug-status').innerText=Math.round(marginScale*100)+"%"; document.querySelector('input[type=range]').value=marginScale; }

    // --- ã‚«ãƒ¡ãƒ©å‡¦ç† (å®‰å®šåŒ–ç‰ˆ) ---
    async function startCamera() {
        if(video.srcObject) return; // æ—¢ã«èµ·å‹•ä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—
        try {
            // ã‚¹ãƒãƒ›è² è·è»½æ¸›ã®ãŸã‚è§£åƒåº¦ã‚’å°‘ã—ä¸‹ã’ã‚‹(640x480)
            const constraints = { 
                video: { 
                    facingMode: "environment", 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 } 
                } 
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã§ã‚‚å†ç”Ÿã•ã‚Œã‚‹ã‚ˆã†ã«å±æ€§ä»˜ä¸
            video.setAttribute("playsinline", true);
            video.setAttribute("muted", true);
            video.onloadedmetadata = () => { 
                canvas.width = video.videoWidth; 
                canvas.height = video.videoHeight; 
                video.play().then(() => {
                    requestAnimationFrame(loop);
                }).catch(e => console.error("Play error:", e));
            };
        } catch(e) { 
            alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nError: " + e.message); 
        }
    }

    let lastTime = 0;
    function loop(timestamp) {
        // ãƒ«ãƒ¼ãƒ—ç¶™ç¶š
        requestAnimationFrame(loop);

        // è² è·è»½æ¸›: 30FPSç¨‹åº¦ã«åˆ¶é™ (ç´„33msé–“éš”)
        if (timestamp - lastTime < 33) return;
        lastTime = timestamp;

        if(video.readyState !== 4) return;
        
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        let markers = [];
        if(detector) markers = detector.detect(imgData);

        // IDã”ã¨ã«æ•´ç†
        let markersById = {};
        TARGET_IDS.forEach(id => markersById[id] = []);
        
        markers.forEach(m => {
            if(TARGET_IDS.includes(m.id)) markersById[m.id].push(m);
        });

        let currentDetection = {};
        TARGET_IDS.forEach(id => currentDetection[id] = "?");

        TARGET_IDS.forEach(id => {
            const ms = markersById[id];
            // 2ã¤ã‚ã‚‹å ´åˆã®ã¿å‡¦ç†
            if(ms.length === 2) {
                const c1 = getCenter(ms[0].corners);
                const c2 = getCenter(ms[1].corners);
                const rect = getBoundingRect(c1, c2, marginScale);

                // Warp
                const srcPoints = [rect.x, rect.y, rect.x + rect.w, rect.y, rect.x + rect.w, rect.y + rect.h, rect.x, rect.y + rect.h];
                const dstPoints = [0,0, PROC_W,0, PROC_W,PROC_H, 0,PROC_H];
                const H = getHomography(srcPoints, dstPoints);
                warpImage(imgData, procCtx, H);

                // Identify
                const procData = procCtx.getImageData(0,0,PROC_W, PROC_H);
                const bin = binarize(procData);
                const feat = getFeature(bin, PROC_W, PROC_H);
                const best = identifyCard(feat);
                
                currentDetection[id] = best;
                drawAR(ctx, rect, id, best);
            }
        });
        detectedNames = currentDetection;
    }

    // --- è¨ˆç®—ãƒ»ç”»åƒå‡¦ç† ---
    function getCenter(corners) { let x=0,y=0; corners.forEach(p=>{x+=p.x;y+=p.y;}); return {x:x/4,y:y/4}; }
    function getBoundingRect(p1, p2, scale) {
        const minX=Math.min(p1.x,p2.x), maxX=Math.max(p1.x,p2.x), minY=Math.min(p1.y,p2.y), maxY=Math.max(p1.y,p2.y);
        const w=maxX-minX, h=maxY-minY, cx=minX+w/2, cy=minY+h/2, nw=w*scale, nh=h*scale;
        return {x:cx-nw/2, y:cy-nh/2, w:nw, h:nh};
    }
    function identifyCard(feat) {
        let best="?", minD=1.0;
        cards.forEach(c=>{if(c.isBlank)return; const d=compare(feat,c.data); if(d<minD){minD=d;best=c.name;}});
        if(blankData){ const bd=compare(feat,blankData); if(bd<minD){minD=bd;best="";} }
        return minD>0.4 ? "?" : best;
    }
    function drawAR(ctx, r, id, name) {
        ctx.strokeStyle = (name!=="?")?"cyan":"rgba(255,255,255,0.5)"; ctx.lineWidth=3; ctx.strokeRect(r.x,r.y,r.w,r.h);
        ctx.fillStyle="white"; ctx.shadowColor="black"; ctx.shadowBlur=4;
        ctx.font="bold 12px sans-serif"; ctx.fillText("ID:"+id, r.x, r.y-5);
        ctx.font="bold 24px sans-serif"; const d=(name==="")?"ç©ºç™½":name; 
        ctx.textAlign="center"; ctx.fillText(d, r.x+r.w/2, r.y+r.h/2+8); ctx.shadowBlur=0; ctx.textAlign="start";
    }
    function getHomography(src,dst){let A=[],B=[];for(let i=0;i<4;i++){let sx=src[i*2],sy=src[i*2+1],dx=dst[i*2],dy=dst[i*2+1];A.push([sx,sy,1,0,0,0,-sx*dx,-sy*dx]);A.push([0,0,0,sx,sy,1,-sx*dy,-sy*dy]);B.push(dx);B.push(dy);}return solveGaussian(A,B).concat([1.0]);}
    function solveGaussian(A,B){let n=A.length;let x=new Array(n);for(let i=0;i<n;i++){let max=Math.abs(A[i][i]),r=i;for(let k=i+1;k<n;k++)if(Math.abs(A[k][i])>max){max=Math.abs(A[k][i]);r=k;}for(let k=i;k<n;k++){let t=A[r][k];A[r][k]=A[i][k];A[i][k]=t;}let t=B[r];B[r]=B[i];B[i]=t;for(let k=i+1;k<n;k++){let c=-A[k][i]/A[i][i];for(let j=i;j<n;j++)if(i==j)A[k][j]=0;else A[k][j]+=c*A[i][j];B[k]+=c*B[i];}}for(let i=n-1;i>=0;i--){let s=0;for(let j=i+1;j<n;j++)s+=A[i][j]*x[j];x[i]=(B[i]-s)/A[i][i];}return x;}
    function invertMatrix(m){const n11=m[0],n12=m[1],n13=m[2],n21=m[3],n22=m[4],n23=m[5],n31=m[6],n32=m[7],n33=m[8],t11=n33*n22-n32*n23,t12=n32*n13-n33*n12,t13=n23*n12-n22*n13,det=n11*t11+n21*t12+n31*t13;if(det===0)return m;const i=1/det;return[t11*i,(n31*n23-n33*n21)*i,(n32*n21-n31*n22)*i,t12*i,(n33*n11-n31*n13)*i,(n31*n12-n32*n11)*i,t13*i,(n21*n13-n23*n11)*i,(n22*n11-n21*n12)*i];}
    function warpImage(src,ctxDst,H){const w=ctxDst.canvas.width,h=ctxDst.canvas.height,dstD=ctxDst.createImageData(w,h),dd=dstD.data,srcD=src.data,sw=src.width,sh=src.height,Hi=invertMatrix(H);for(let y=0;y<h;y++)for(let x=0;x<w;x++){const u=Hi[0]*x+Hi[1]*y+Hi[2],v=Hi[3]*x+Hi[4]*y+Hi[5],s=Hi[6]*x+Hi[7]*y+Hi[8],sx=Math.floor(u/s),sy=Math.floor(v/s),di=(y*w+x)*4;if(sx>=0&&sx<sw&&sy>=0&&sy<sh){const si=(sy*sw+sx)*4;dd[di]=srcD[si];dd[di+1]=srcD[si+1];dd[di+2]=srcD[si+2];dd[di+3]=255;}else dd[di+3]=0;}ctxDst.putImageData(dstD,0,0);}
    function binarize(d){const b=new ImageData(d.width,d.height),bd=b.data,dd=d.data;for(let i=0;i<dd.length;i+=4){const v=(dd[i]+dd[i+1]+dd[i+2])/3<threshold?0:255;bd[i]=bd[i+1]=bd[i+2]=v;bd[i+3]=255;}return b;}
    function getFeature(b,w,h){const p=[],d=b.data,step=3;for(let y=0;y<h;y+=step)for(let x=0;x<w;x+=step)p.push(d[((y*w+x)*4)]===0?1:0);return p;}
    function compare(a,b){if(!a||!b||a.length!=b.length)return 1;let d=0,c=0;for(let i=0;i<a.length;i++){if(a[i]!=b[i])d++;c++;}return c?d/c:1;}

    // --- UI/Data ---
    function registerImage(input) {
        if(!input.files[0]) return;
        const name = document.getElementById('reg-name').value || "Card"+(cards.length+1);
        const isBlank = document.getElementById('is-blank-check').checked;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image(); img.onload = () => {
                const c = document.createElement('canvas'); c.width=PROC_W; c.height=PROC_H;
                const t = c.getContext('2d'); t.drawImage(img,0,0,PROC_W,PROC_H);
                const bin = binarize(t.getImageData(0,0,PROC_W,PROC_H));
                const data = getFeature(bin,PROC_W,PROC_H);
                t.putImageData(bin,0,0);
                const thumb = c.toDataURL();
                const nc = {name,data,thumb,isBlank};
                if(isBlank){ blankData=data; cards=cards.filter(x=>!x.isBlank); cards.unshift(nc); } else cards.push(nc);
                saveData(); renderUI(); input.value=""; showToast("ç™»éŒ²: "+name);
            }; img.src=e.target.result;
        }; r.readAsDataURL(input.files[0]);
    }
    function addLevel(){ levels.push({title:document.getElementById('lvl-name').value||"ç„¡é¡Œ",order:TARGET_IDS.map(id=>document.getElementById('sel-'+id).value)}); saveData(); renderUI(); }
    function judge(){
        if(!levels.length){alert("æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“");return;}
        const target = currentTarget.length ? currentTarget : levels[0].order;
        let ok=true;
        // targeté…åˆ—ã¯ [ID0ã®æ­£è§£, ID10ã®æ­£è§£, ID20ã®æ­£è§£, ID30ã®æ­£è§£] ã®é †
        TARGET_IDS.forEach((id, idx) => {
            if(detectedNames[id] !== target[idx]) ok=false;
        });
        document.getElementById('result-overlay').style.display='flex';
        const m=document.getElementById('res-msg'); m.innerText=ok?"æ­£è§£!!":"ä¸æ­£è§£..."; m.style.color=ok?"#0f0":"#f00";
    }
    function renderUI(){
        const cl=document.getElementById('reg-list'); cl.innerHTML="";
        cards.forEach((c,i)=>{cl.innerHTML+=`<div class="card-thumb" style="${c.isBlank?'border:2px dashed #0f0':''}"><img src="${c.thumb}"><div style="font-size:10px;">${c.name}</div><div style="position:absolute;top:0;right:0;background:red;width:20px;text-align:center;cursor:pointer;color:white;" onclick="delCard(${i})">Ã—</div></div>`;});
        TARGET_IDS.forEach(id => {
            const s=document.getElementById('sel-'+id); s.innerHTML="<option value=''>- ç©ºç™½ -</option>"; 
            cards.forEach(c=>{if(!c.isBlank)s.innerHTML+=`<option value="${c.name}">${c.name}</option>`});
        });
        const ll=document.getElementById('level-list'); ll.innerHTML="";
        levels.forEach((l,i)=>{ll.innerHTML+=`<div style="background:#333;padding:5px;margin-bottom:5px;border-radius:4px;display:flex;justify-content:space-between;"><div><b>${l.title}</b><div style="font-size:10px;color:#aaa;">${l.order.join(',')}</div></div><div><button class="btn-mini btn-edit" onclick="selLevel(${i})">é¸æŠ</button><button class="btn-mini btn-del" onclick="delLevel(${i})">å‰Šé™¤</button></div></div>`;});
    }
    function delCard(i){if(confirm("å‰Šé™¤?")){cards.splice(i,1);saveData();renderUI();}}
    function delLevel(i){levels.splice(i,1);saveData();renderUI();}
    function selLevel(i){currentTarget=levels[i].order; showToast("é¸æŠ: "+levels[i].title); closeSettings();}
    function saveData(){localStorage.setItem('cm_v29',JSON.stringify({cards,levels,blankData}));}
    function loadData(){const d=localStorage.getItem('cm_v29');if(d){const j=JSON.parse(d);cards=j.cards||[];levels=j.levels||[];blankData=j.blankData;}}
    function resetData(){if(confirm("å…¨æ¶ˆå»?")){localStorage.clear();location.reload();}}
    function showToast(m){const e=document.getElementById('status-msg');e.innerText=m;e.style.opacity=1;setTimeout(()=>e.style.opacity=0,2000);}
    function openSettings(){document.getElementById('settings-overlay').classList.add('open');}
    function closeSettings(){document.getElementById('settings-overlay').classList.remove('open');}

    // --- ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½ ---
    function showMarkers() {
        const w = window.open('','_blank');
        // Original ArUco Dictionary IDs: 0, 10, 20, 30
        const markers = {
            0: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAgMAAADXB5lNAAAACVBMVEUAAAD///8AAABz1c1UAAAAKElEQVQ4y2P4DwM8YICgA4b/YICiA4b/oICqA4b/sICuA4b/8ICyAwYAm3c/wXW1m1sAAAAASUVORK5CYII=",
            10: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAgMAAADXB5lNAAAACVBMVEUAAAD///8AAABz1c1UAAAALklEQVQ4y2P4DwM8YICgA4b/YICiA4b/oICqA4b/sICuA4b/8ICyA4b/UMAAAwB+eT/B5q0lRwAAAABJRU5ErkJggg==",
            20: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAgMAAADXB5lNAAAACVBMVEUAAAD///8AAABz1c1UAAAAL0lEQVQ4y2P4DwM8YICgA4b/YICiA4b/oICqA4b/sICuA4b/8ICyA4b/UMAAAgAAf3k/wY0qvb4AAAAASUVORK5CYII=",
            30: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAgMAAADXB5lNAAAACVBMVEUAAAD///8AAABz1c1UAAAALklEQVQ4y2P4DwM8YICgA4b/YICiA4b/oICqA4b/sICuA4b/8ICyA4b/UMAAAwB+eT/B5q0lRwAAAABJRU5ErkJggg=="
        };
        // å®Ÿéš›ã«ã¯JSã§ç”Ÿæˆã‚‚å¯èƒ½ã ãŒBase64ã§åŸ‹ã‚è¾¼ã‚€
        // æ³¨: ä¸Šè¨˜ã¯ãƒ€ãƒŸãƒ¼ã§ã¯ãªãå®Ÿãƒ‡ãƒ¼ã‚¿ã«å·®ã—æ›¿ãˆã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã ãŒã€ã“ã“ã§ã¯ArUco Originalã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿‘ä¼¼
        // ç¢ºå®ŸãªArUcoãƒãƒ¼ã‚«ãƒ¼ç”Ÿæˆãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã‚‚æä¾›
        w.document.write(`
            <html><head><title>Markers</title>
            <style>body{font-family:sans-serif;text-align:center;} .m{margin:20px;display:inline-block;} img{width:150px;border:1px solid #ddd;image-rendering:pixelated;}</style>
            </head><body>
            <h2>ArUco Markers (Original Dictionary)</h2>
            <p>å°åˆ·ã—ã¦åˆ‡ã‚Šå–ã‚Šã€ã‚«ãƒ¼ãƒ‰ã®å¯¾è§’ç·šã«é…ç½®ã—ã¦ãã ã•ã„</p>
            <div class="m">ID:0<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=0&size=100"></div>
            <div class="m">ID:10<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=10&size=100"></div>
            <div class="m">ID:20<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=20&size=100"></div>
            <div class="m">ID:30<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=30&size=100"></div>
            <p><button onclick="window.print()">å°åˆ·ã™ã‚‹</button></p>
            </body></html>
        `);
    }

    // --- åŒæœŸæ©Ÿèƒ½ ---
    function startHost() {
        if(typeof Peer==='undefined'){alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");return;}
        if(peer) peer.destroy();
        peer = new Peer();
        const area = document.getElementById('sync-area');
        const qrel = document.getElementById('qrcode');
        const msg = document.getElementById('sync-msg');
        
        area.style.display = 'block';
        qrel.innerHTML = "";
        msg.innerText = "ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šä¸­...";

        peer.on('open', id => {
            const url = window.location.href.split('?')[0] + "?sync=" + id;
            new QRCode(qrel, {text: url, width: 150, height: 150});
            msg.innerText = "ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã£ã¦ãã ã•ã„";
        });
        peer.on('connection', conn => {
            msg.innerText = "æ¥ç¶šã•ã‚Œã¾ã—ãŸï¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­...";
            conn.on('open', () => {
                conn.send({cards, levels, blankData});
                setTimeout(()=>{ msg.innerText="é€ä¿¡å®Œäº†"; }, 500);
            });
        });
    }

    function startClient(hostId) {
        if(typeof Peer==='undefined') return;
        if(peer) peer.destroy();
        peer = new Peer();
        showToast("ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚’é–‹å§‹ã—ã¾ã™...");
        peer.on('open', () => {
            const conn = peer.connect(hostId);
            conn.on('data', data => {
                if(data && data.cards) {
                    cards = data.cards; levels = data.levels; blankData = data.blankData;
                    saveData(); renderUI();
                    showToast("åŒæœŸå®Œäº†ï¼");
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            });
        });
    }
</script>
</body>
</html>
