<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Card Master V7 (Upload)</title>
    <style>
        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šç¾© --- */
        body { 
            font-family: sans-serif; background: #000; color: #fff; margin: 0; 
            overflow: hidden; width: 100vw; height: 100dvh;
            display: flex; justify-content: center; align-items: center;
        }
        
        #app-container { 
            position: relative; width: 96%; height: 98dvh; max-width: 600px; 
            background: #000; overflow: hidden; border-radius: 12px;
            box-shadow: 0 0 30px rgba(255,255,255,0.1);
        }

        video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; opacity: 0.4; transition: opacity 0.5s;
        }
        video.active { opacity: 1.0; }

        /* ç”»é¢ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; 
            padding: 15px; box-sizing: border-box; z-index: 10;
            pointer-events: none;
        }
        .screen > * { pointer-events: auto; }
        .hidden { display: none !important; }

        /* ã‚°ãƒªãƒƒãƒ‰ (ç‰©ç†æ¯”ç‡) */
        .slot-container {
            width: 100%; height: 28vw; max-height: 180px; margin-top: 15vh;
            display: flex; justify-content: space-between; align-items: center;
        }
        .slot {
            width: 20.2%; height: 100%; 
            border: 2px solid #0f0; background: rgba(255,255,255,0.05);
            box-sizing: border-box; border-radius: 6px; position: relative;
        }
        .slot-info {
            position: absolute; bottom: -25px; left: 0; width: 100%;
            text-align: center; font-size: 11px; color: #0f0; font-weight: bold;
        }

        /* UIãƒ‘ãƒ¼ãƒ„ */
        h1 { font-size: 2.2rem; margin-top: 25%; color: #fff; letter-spacing: 2px; text-shadow: 0 0 15px rgba(255,255,255,0.5); }
        
        #level-list { width: 94%; flex: 1; overflow-y: auto; margin-top: 30px; }
        .level-item {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            padding: 18px; margin-bottom: 10px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; font-weight: bold; backdrop-filter: blur(5px);
        }

        .btn-main {
            padding: 15px 40px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 50px; color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .judge-btn {
            position: absolute; bottom: 40px; width: 85%;
            background: linear-gradient(to bottom, #28a745, #208030);
        }

        /* è¨­å®šç”»é¢ */
        #settings-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 100; transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
            padding: 20px; overflow-y: auto; box-sizing: border-box;
        }
        #settings-overlay.open { transform: translateY(0); }
        
        .setting-box { background: #252525; padding: 18px; border-radius: 12px; margin-bottom: 25px; }
        h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        .card-list { display: flex; overflow-x: auto; gap: 12px; padding: 15px 0; }
        .card-thumb { 
            min-width: 65px; height: 85px; background: #000; 
            border: 1px solid #555; position: relative; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .card-thumb img { width: 100%; height: 100%; object-fit: contain; }

        input, select { padding: 12px; border-radius: 6px; border: 1px solid #444; background: #333; color: #fff; font-size: 16px; }
        
        #result-view {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); display: none; z-index: 200;
            flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
        .file-upload-btn {
            display: inline-block; padding: 10px 15px; background: #555; 
            color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px; 
            text-align: center; margin-top: 5px; width: 100%; box-sizing: border-box;
        }
        
        #gear-icon {
            position:absolute; top:15px; right:15px; font-size:28px; z-index:50; cursor:pointer;
            background: rgba(0,0,0,0.5); width: 44px; height: 44px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        
        /* éè¡¨ç¤ºã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ */
        #file-input { display: none; }
    </style>
</head>
<body>

<div id="app-container">
    <video id="video-bg" autoplay playsinline muted></video>
    <div id="gear-icon" onclick="openSettings()">âš™ï¸</div>

    <div id="screen-title" class="screen">
        <h1>CARD MASTER</h1>
        <div id="level-list">
            <p style="color:#aaa; text-align:center; margin-top:50px;">è¨­å®šã‹ã‚‰å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
        </div>
    </div>

    <div id="screen-game" class="screen hidden">
        <button onclick="goTitle()" style="position:absolute; top:25px; left:20px; padding:8px 20px; background:rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.5); color:#fff; border-radius:30px; font-weight:bold;">â† BACK</button>
        <div style="position:absolute; top:30px; width:100%; text-align:center; font-weight:bold; font-size:1.2rem; text-shadow:0 2px 5px #000;" id="game-title-text">LEVEL</div>

        <div class="slot-container">
            <div class="slot"><div class="slot-info" id="info-0">-</div></div>
            <div class="slot"><div class="slot-info" id="info-1">-</div></div>
            <div class="slot"><div class="slot-info" id="info-2">-</div></div>
            <div class="slot"><div class="slot-info" id="info-3">-</div></div>
        </div>
        <button class="btn-main judge-btn" onclick="judge()">åˆ¤ å®š !</button>
    </div>

    <div id="settings-overlay">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">è¨­å®š</h2>
            <button onclick="closeSettings()" style="padding:10px 25px; background:#444; color:#fff; border:none; border-radius:30px; font-weight:bold;">é–‰ã˜ã‚‹</button>
        </div>

        <div class="setting-box">
            <h3>A. ã‚«ãƒ¼ãƒ‰ç™»éŒ²</h3>
            
            <input type="text" id="reg-name" placeholder="ã‚«ãƒ¼ãƒ‰å (ä¾‹: â˜…æ˜Ÿ)" style="width:100%; box-sizing:border-box; margin-bottom:10px;">
            
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button onclick="registerCard('camera')" style="flex:1; background:#007bff; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">ğŸ“· ã‚«ãƒ¡ãƒ©ã§ç™»éŒ²</button>
            </div>
            <p style="font-size:11px; color:#aaa; margin:0 0 10px 0;">â€»ã‚«ãƒ¡ãƒ©ã®å ´åˆ: ä¸€ç•ªå·¦(Slot1)ã«ç½®ã„ã¦æŠ¼ã™</p>

            <label class="file-upload-btn">
                ğŸ“ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ç™»éŒ²
                <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(this)">
            </label>

            <div class="card-list" id="reg-list"></div>
        </div>

        <div class="setting-box">
            <h3>B. å•é¡Œä½œæˆ</h3>
            <input type="text" id="lvl-name" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: ãƒ¬ãƒ™ãƒ«1)" style="width:100%; box-sizing:border-box; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; gap:5px; margin-bottom:15px;">
                <select id="sel-0" style="flex:1;"><option>-</option></select>
                <select id="sel-1" style="flex:1;"><option>-</option></select>
                <select id="sel-2" style="flex:1;"><option>-</option></select>
                <select id="sel-3" style="flex:1;"><option>-</option></select>
            </div>
            <button onclick="addLevel()" style="width:100%; padding:15px; background:#28a745; color:white; border:none; border-radius:8px; font-weight:bold;">ï¼‹ ã‚¿ã‚¤ãƒˆãƒ«ã«è¿½åŠ </button>
        </div>

        <div class="setting-box" style="background:#300;">
            <button onclick="resetData()" style="width:100%; padding:15px; background:#d00; color:white; border:none; border-radius:8px; font-weight:bold;">âš  å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>
    </div>

    <div id="result-view" onclick="this.style.display='none'">
        <div id="res-msg" style="font-size:5rem; font-weight:900; margin-bottom:30px;"></div>
        <div style="font-size:1.2rem;">Tap to close</div>
    </div>
</div>

<canvas id="proc-canvas" style="display:none;"></canvas>

<script>
    // --- å®šæ•° ---
    const SLOT_WIDTH_PCT = 0.2019; 
    const GAP_PCT = 0.0641;        
    const SLOT_X_PCT = [0, SLOT_WIDTH_PCT+GAP_PCT, (SLOT_WIDTH_PCT+GAP_PCT)*2, (SLOT_WIDTH_PCT+GAP_PCT)*3];

    let cards = []; 
    let levels = [];
    let currentTarget = [];
    let detected = ["","","",""];

    const video = document.getElementById('video-bg');
    const pCanvas = document.getElementById('proc-canvas');
    const pCtx = pCanvas.getContext('2d');

    // --- åˆæœŸåŒ– ---
    window.onload = () => {
        loadData();
        startCam();
    };

    function startCam() {
        navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
        }).then(stream => {
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                pCanvas.width = 320; pCanvas.height = 180; 
                setInterval(process, 150);
            };
        }).catch(e => {
            console.log(e); // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã¿ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã‚¢ãƒ©ãƒ¼ãƒˆã¯å‡ºã•ãªã„
        });
    }

    // --- å‡¦ç†ã‚³ã‚¢ ---
    function process() {
        if(cards.length === 0 || video.readyState !== 4) return;
        pCtx.drawImage(video, 0, 0, pCanvas.width, pCanvas.height);
        
        const frameW = pCanvas.width; const frameH = pCanvas.height;
        const scanH = frameH * 0.3; const scanY = (frameH - scanH) / 2;

        const frameData = pCtx.getImageData(0, 0, frameW, frameH);
        const binaryFrame = binarizeImageData(frameData);

        let detectedNow = [];
        for(let i=0; i<4; i++) {
            const cx = SLOT_X_PCT[i] * frameW; const cw = SLOT_WIDTH_PCT * frameW;
            const safeMargin = cw * 0.25;
            const cutX = Math.floor(cx + safeMargin);
            const cutW = Math.floor(cw - safeMargin * 2);
            
            const slotData = getBinaryRegion(binaryFrame, cutX, scanY, cutW, scanH, frameW);

            let bestName = "?";
            let minScore = Infinity;

            cards.forEach(c => {
                const diff = compareBinary(slotData, c.data);
                if(diff < minScore) {
                    minScore = diff;
                    if(diff < 0.15) bestName = c.name; 
                }
            });
            detectedNow.push(bestName);
            
            const info = document.getElementById(`info-${i}`);
            if(info) {
                info.innerText = bestName === "?" ? "" : bestName;
                info.style.color = bestName === "?" ? "rgba(255,255,255,0.3)" : "#0f0";
            }
        }
        detected = detectedNow;
    }

    function binarizeImageData(imgData) {
        const d = imgData.data;
        const bin = new ImageData(imgData.width, imgData.height);
        const bd = bin.data;
        for(let i=0; i<d.length; i+=4) {
            const gray = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114);
            const val = gray < 100 ? 0 : 255; 
            bd[i] = bd[i+1] = bd[i+2] = val; bd[i+3] = 255;
        }
        return bin;
    }

    function getBinaryRegion(binImg, x, y, w, h, totalW) {
        const d = binImg.data;
        let pattern = [];
        const step = 3; 
        for(let py=y; py<y+h; py+=step) {
            for(let px=x; px<x+w; px+=step) {
                const idx = (py * totalW + px) * 4;
                pattern.push(d[idx] === 0 ? 1 : 0);
            }
        }
        return pattern;
    }

    function compareBinary(pat1, pat2) {
        if(pat1.length !== pat2.length) return 1.0;
        let diff = 0;
        for(let i=0; i<pat1.length; i++) {
            if(pat1[i] !== pat2[i]) diff++;
        }
        return diff / pat1.length;
    }

    // --- ç™»éŒ²å‡¦ç† (ã‚«ãƒ¡ãƒ© & ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰) ---
    
    // 1. ã‚«ãƒ¡ãƒ©ç™»éŒ²
    function registerCard(mode) {
        const nameInput = document.getElementById('reg-name');
        const name = nameInput.value || "NoName";
        
        pCtx.drawImage(video, 0, 0, pCanvas.width, pCanvas.height);
        const frameData = pCtx.getImageData(0, 0, pCanvas.width, pCanvas.height);
        const binaryFrame = binarizeImageData(frameData);
        
        // Slot 1 åˆ‡ã‚Šå‡ºã—
        const frameW = pCanvas.width; const frameH = pCanvas.height;
        const cx = SLOT_X_PCT[0] * frameW; const cw = SLOT_WIDTH_PCT * frameW;
        const scanH = frameH * 0.3; const scanY = (frameH - scanH) / 2;
        const safeMargin = cw * 0.25;
        const cutX = Math.floor(cx + safeMargin);
        const cutW = Math.floor(cw - safeMargin * 2);

        const featureData = getBinaryRegion(binaryFrame, cutX, scanY, cutW, scanH, frameW);
        const tCan = document.createElement('canvas');
        tCan.width = cutW; tCan.height = scanH;
        tCan.getContext('2d').putImageData(binaryFrame, -cutX, -scanY); 
        
        saveAndReset(name, featureData, tCan.toDataURL());
    }

    // 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç™»éŒ²
    function handleFileUpload(input) {
        if (input.files && input.files[0]) {
            const nameInput = document.getElementById('reg-name');
            const name = nameInput.value || "UploadImg";
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // ã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨ã®åˆ¤å®šã‚µã‚¤ã‚º(Slot1ã®ã‚µã‚¤ã‚º)ã«åˆã‚ã›ã¦ãƒªã‚µã‚¤ã‚º
                    const frameW = pCanvas.width; const frameH = pCanvas.height;
                    const cw = SLOT_WIDTH_PCT * frameW;
                    const scanH = frameH * 0.3;
                    const safeMargin = cw * 0.25;
                    const targetW = Math.floor(cw - safeMargin * 2);
                    const targetH = scanH;

                    // ä¸€æ™‚Canvasã«æç”»ã—ã¦ãƒ‡ãƒ¼ã‚¿åŒ–
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = targetW; tempCanvas.height = targetH;
                    const tCtx = tempCanvas.getContext('2d');
                    tCtx.drawImage(img, 0, 0, targetW, targetH);
                    
                    // 2å€¤åŒ–å‡¦ç†
                    const imgData = tCtx.getImageData(0, 0, targetW, targetH);
                    const binData = binarizeImageData(imgData);
                    
                    // ç‰¹å¾´é‡æŠ½å‡º (0,0ã‹ã‚‰å…¨åŸŸ)
                    const featureData = getBinaryRegion(binData, 0, 0, targetW, targetH, targetW);
                    
                    // ä¿å­˜ç”¨ã‚µãƒ ãƒ (2å€¤åŒ–å¾Œã®ã‚‚ã®ã‚’ä¿å­˜)
                    tCtx.putImageData(binData, 0, 0);
                    
                    saveAndReset(name, featureData, tempCanvas.toDataURL());
                    
                    input.value = ""; // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveAndReset(name, data, thumb) {
        cards.push({ name: name, data: data, thumb: thumb });
        saveData();
        renderSettings();
        
        // åå‰æ›´æ–°
        const nameInput = document.getElementById('reg-name');
        let nextNum = cards.length + 1;
        nameInput.value = "ã‚«ãƒ¼ãƒ‰" + nextNum;
        alert("ç™»éŒ²ã—ã¾ã—ãŸ: " + name);
    }

    // --- å…±é€šUI/ä¿å­˜ ---
    function openSettings() { document.getElementById('settings-overlay').classList.add('open'); }
    function closeSettings() { document.getElementById('settings-overlay').classList.remove('open'); }
    
    function renderSettings() {
        const list = document.getElementById('reg-list');
        list.innerHTML = "";
        cards.forEach((c, i) => {
            list.innerHTML += `<div class="card-thumb" onclick="if(confirm('å‰Šé™¤ã—ã¾ã™ã‹?')) { cards.splice(${i},1); saveData(); renderSettings(); }"><img src="${c.thumb}"><div style="position:absolute;bottom:0;background:rgba(0,0,0,0.7);color:#fff;width:100%;text-align:center;font-size:10px;">${c.name}</div></div>`;
        });
        
        for(let j=0; j<4; j++) {
            const sel = document.getElementById(`sel-${j}`);
            const old = sel.value;
            sel.innerHTML = "<option value='-'>-</option>";
            cards.forEach(c => sel.innerHTML += `<option value='${c.name}'>${c.name}</option>`);
            sel.value = old;
        }
    }

    function addLevel() {
        const t = document.getElementById('lvl-name').value || `å•é¡Œ ${levels.length+1}`;
        const o = [0,1,2,3].map(i=>document.getElementById(`sel-${i}`).value);
        if(o.includes("-")) return alert("4æšé¸æŠã—ã¦ãã ã•ã„");
        levels.push({title:t, order:o});
        saveData();
        renderLevels();
        alert("è¿½åŠ ã—ã¾ã—ãŸ");
        closeSettings();
    }

    function renderLevels() {
        const d = document.getElementById('level-list');
        d.innerHTML = "";
        if(levels.length===0) { d.innerHTML = '<p style="color:#aaa;text-align:center;margin-top:50px;">è¨­å®šã‹ã‚‰å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„</p>'; return; }
        levels.forEach((l, i) => {
            d.innerHTML += `<div class="level-item" onclick="startLevel(${i})"><span>${l.title}</span> <span onclick="event.stopPropagation(); if(confirm('å‰Šé™¤?')){ levels.splice(${i},1); saveData(); renderLevels(); }" style="padding:10px;">ğŸ—‘ï¸</span></div>`;
        });
    }

    function startLevel(i) {
        currentTarget = levels[i].order;
        document.getElementById('game-title-text').innerText = levels[i].title;
        document.getElementById('screen-title').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');
        video.classList.add('active');
    }
    
    function goTitle() {
        document.getElementById('screen-game').classList.add('hidden');
        document.getElementById('screen-title').classList.remove('hidden');
        video.classList.remove('active');
    }

    function judge() {
        const ok = JSON.stringify(detected) === JSON.stringify(currentTarget);
        const m = document.getElementById('res-msg');
        m.innerText = ok ? "æ­£è§£!!" : "ä¸æ­£è§£...";
        m.style.color = ok ? "#0f0" : "#f00";
        document.getElementById('result-view').style.display = 'flex';
    }

    function saveData() {
        localStorage.setItem('cm_v7_cards', JSON.stringify(cards));
        localStorage.setItem('cm_v7_levels', JSON.stringify(levels));
    }
    function loadData() {
        const c = localStorage.getItem('cm_v7_cards');
        const l = localStorage.getItem('cm_v7_levels');
        if(c) cards = JSON.parse(c);
        if(l) levels = JSON.parse(l);
        renderSettings();
        renderLevels();
    }
    function resetData() { if(confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>