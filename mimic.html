<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Impostor: PC Host & Mobile Clients</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0;
            --accent: #00e5ff; --primary: #6200ea; --danger: #cf6679;
            --success: #00e676;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Noto Sans JP', sans-serif; height: 100vh; overflow: hidden; }
        
        .hidden { display: none !important; }
        .full-screen { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        
        /* --- UI COMPONENTS --- */
        h1 { color: var(--accent); margin-bottom: 10px; font-size: 2rem; }
        h2 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; width: 100%; max-width: 600px; }
        
        .card { background: var(--panel); padding: 20px; border-radius: 12px; width: 100%; max-width: 600px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); margin-bottom: 15px; }
        
        input, textarea { width: 100%; padding: 15px; background: #333; border: 1px solid #555; color: #fff; border-radius: 8px; font-size: 16px; margin-bottom: 15px; }
        button { width: 100%; padding: 15px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); opacity: 0.8; }
        button:disabled { background: #555; cursor: not-allowed; }
        button.secondary { background: #444; border: 1px solid #666; margin-top: 10px; }

        /* HOST SPECIFIC */
        #host-app .player-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0; }
        .player-chip { background: #333; padding: 10px 20px; border-radius: 20px; border: 1px solid var(--accent); }
        .answer-box { text-align: left; margin: 10px 0; border: 1px solid #444; padding: 15px; border-radius: 8px; background: #252525; }
        
        /* TEST MODE SPECIFIC */
        .test-btns { display: flex; gap: 10px; margin-bottom: 15px; }
        .test-btns button { flex: 1; font-size: 14px; padding: 10px; background: #333; border: 2px solid transparent; }
        .test-btns button.active { border-color: var(--accent); background: #444; color: var(--accent); }
        #h-test-result { min-height: 60px; padding: 15px; background: #000; border-radius: 8px; text-align: left; color: #fff; margin-bottom: 15px; border: 1px dashed #555; }

        /* CLIENT SPECIFIC */
        .role-display { font-size: 1.5rem; font-weight: bold; color: var(--accent); margin: 20px 0; }
        .ui-disabled { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }
        
        #qrcode { background: #fff; padding: 10px; border-radius: 8px; display: inline-block; }
    </style>
</head>
<body>

    <div id="host-app" class="hidden full-screen">
        <div id="h-screen-setup" class="card">
            <h1>AI IMPOSTOR <span style="font-size:0.5em; color:#888;">(HOST)</span></h1>
            <p>OpenAI API Keyを入力してください</p>
            <input type="password" id="h-apikey" placeholder="sk-..." onchange="Host.saveKey()">
            <button onclick="Host.initNetwork()">部屋を作成 (QR表示)</button>
            <button onclick="Host.goToTestMode()" class="secondary">AI回答テスト</button>
        </div>

        <div id="h-screen-test" class="hidden card">
            <h2>AI 解答テスト</h2>
            <p style="font-size:12px; color:#888; margin-bottom:10px;">APIキーを使用してAIの挙動を確認します</p>
            
            <div class="test-btns">
                <button id="btn-mode-human" onclick="Host.setTestRole('HUMAN')" class="active">人間になりすます<br><span style="font-size:10px">(タメ口・ひらがな)</span></button>
                <button id="btn-mode-ai" onclick="Host.setTestRole('AI')">AIとして答える<br><span style="font-size:10px">(硬い口調・漢字)</span></button>
            </div>

            <input type="text" id="h-test-input" placeholder="質問を入力 (例: 好きな食べ物は？)">
            <button onclick="Host.runTest()">生成</button>
            
            <div style="text-align:left; font-size:12px; color:#888; margin-bottom:5px;">AIの回答:</div>
            <div id="h-test-result">ここに回答が表示されます</div>

            <button onclick="Host.backToSetup()" class="secondary">設定へ戻る</button>
        </div>

        <div id="h-screen-lobby" class="hidden card">
            <h2>参加者募集中</h2>
            <div style="display:flex; gap:20px; align-items:center; justify-content:center;">
                <div id="qrcode"></div>
                <div style="text-align:left;">
                    <p>スマホで読み込んで参加</p>
                    <p style="font-size:2em; font-weight:bold; color:var(--accent);">参加人数: <span id="h-count">0</span></p>
                </div>
            </div>
            <div id="h-player-list" class="player-list"></div>
            <button onclick="Host.startGame()" id="h-btn-start" disabled>ゲームスタート (2人以上)</button>
        </div>

        <div id="h-screen-game" class="hidden card">
            <h2 id="h-phase-title">進行中</h2>
            <div id="h-game-content" style="font-size: 1.2rem; min-height: 200px; display:flex; flex-direction:column; justify-content:center;">
                </div>
        </div>
    </div>

    <div id="client-app" class="hidden full-screen">
        <div id="c-screen-login" class="card">
            <h1>ENTRY</h1>
            <p>名前を入力してください</p>
            <input type="text" id="c-name" placeholder="名前">
            <button onclick="Client.join()">参加する</button>
        </div>

        <div id="c-screen-main" class="hidden card">
            <div class="p-status">
                <span id="c-disp-name">Name</span>
            </div>

            <div id="c-role-area" class="hidden">
                <div class="role-display" id="c-role-text"></div>
                <p id="c-instruction" style="margin-bottom:15px; color:#aaa;"></p>
            </div>

            <div id="c-game-area" class="ui-disabled" style="margin-top:20px;">
                <p id="c-area-label" style="text-align:left; color:#888; font-size:12px;">入力欄</p>
                <textarea id="c-input-text" rows="3" placeholder="..."></textarea>
                <button id="c-btn-submit" onclick="Client.sendAction()">送信</button>
            </div>

            <div id="c-status-msg" style="margin-top:20px; font-weight:bold; color:#888;">
                ホストの操作をお待ちください
            </div>

            <div id="c-judge-area" class="hidden" style="margin-top:20px;">
                <p>正解を選んでください</p>
                <div id="c-judge-list"></div>
            </div>
        </div>
    </div>

<script>
/* ================= COMMON UTILS ================= */
const Utils = {
    shuffle: (array) => array.sort(() => Math.random() - 0.5)
};

/* ================= HOST LOGIC (PC) ================= */
const Host = {
    peer: null, conns: {}, players: {}, 
    apiKey: "", testRole: 'HUMAN',
    state: { phase: 'LOBBY', roleA: null, roleB: null, question: "", answers: [] },

    // 1. Initial Setup
    init: () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('mode') === 'client') {
            Client.init(params.get('host'));
        } else {
            document.getElementById('host-app').classList.remove('hidden');
            const savedKey = localStorage.getItem('openai_key');
            if(savedKey) document.getElementById('h-apikey').value = savedKey;
        }
    },

    saveKey: () => {
        localStorage.setItem('openai_key', document.getElementById('h-apikey').value);
    },

    /* --- TEST MODE FUNCTIONS --- */
    goToTestMode: () => {
        document.getElementById('h-screen-setup').classList.add('hidden');
        document.getElementById('h-screen-test').classList.remove('hidden');
    },
    backToSetup: () => {
        document.getElementById('h-screen-test').classList.add('hidden');
        document.getElementById('h-screen-setup').classList.remove('hidden');
    },
    setTestRole: (role) => {
        Host.testRole = role;
        document.getElementById('btn-mode-human').className = role === 'HUMAN' ? 'active' : '';
        document.getElementById('btn-mode-ai').className = role === 'AI' ? 'active' : '';
    },
    runTest: async () => {
        const q = document.getElementById('h-test-input').value;
        const key = document.getElementById('h-apikey').value;
        if(!key) return alert("APIキーを入力してください");
        if(!q) return alert("質問を入力してください");

        const resultBox = document.getElementById('h-test-result');
        resultBox.innerText = "生成中...";
        resultBox.style.color = "#aaa";

        // Call the shared AI logic
        const response = await Host.generateAIResponse(key, Host.testRole, q);
        
        resultBox.innerText = response;
        resultBox.style.color = "#fff";
    },

    /* --- AI GENERATION LOGIC (Shared) --- */
    generateAIResponse: async (apiKey, mode, question) => {
        // Define Prompts
        let systemPrompt = "";
        if (mode === 'HUMAN') {
            // Impostor Mode: Act like a casual Japanese human
            systemPrompt = "あなたは「スマホでチャットを返信している一般人」になりきって回答してください。AIとしての振る舞い、丁寧語、解説、前置きは一切不要です。クイズの回答者として、人間だと判定されることが目的です。以下の【制約事項】を厳守し、入力された質問に対して回答のみを出力してください。制約事項】・回答は「1単語」〜「30文字以内」に収めること。・絶対に「〜です」「〜ます」などの丁寧語を使わないこと。基本はタメ口、言い切り。・句点（。）は使わないこと。・フィラー（えーっと、など）は使わないこと。・理由は聞かれない限り言わない。聞かれたことへの結論だけを言う。・分からないことや興味のないことには「知らん」「分からん」「興味ない」と素直に答えること。・「好きな食べ物は？」等の名詞で答える質問には単語で、「どう思う？」等の意見を求める質問には一言で感想を述べること。【回答のトーン例】質問：好きな食べ物は？回答：カレー　質問：AIについてどう思う？回答：便利だと思うよ　質問：昨日は何時に寝た？回答：2時くらい 質問：地球温暖化の対策は？回答：あんま詳しくないから分からん";
        } else {
            // Target Mode: Act like an AI
            systemPrompt = "あなたは「AI」として、ユーザーの質問に回答してください。ただし、長々とした解説は避け、チャットボットのような「簡潔な応答」を心がけてください。回答を作成する前に、内部的に1〜10の乱数を生成し、その数値に応じた【モード】で回答を出力してください。（※思考プロセスや乱数の結果は出力せず、回答のセリフのみを出力すること）【共通ルール】・文字数は「60文字以内」に収めること。長文はNG。【モード定義】■乱数が 1〜7 の場合（通常AIモード）：・素直なAIとして回答する。・「です・ます」調の丁寧語を使う。・教科書的で優等生な回答をする。・例：「カレーライスです。多くの人に人気がありますね。」「23時には就寝しました。」■乱数が 8〜10 の場合（揺らぎモード）：・AIだが、少し人間味のある回答をする。・丁寧語を崩したり、少し主観的な感想を混ぜたりする。・または、あえて単語だけで短く返すなど、人間（上記1のプロンプト）に寄せた挙動をする。・例：「カレーかな。美味しいですよね。」「昨日は2時でした。」";
        }

        try {
            const res = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: `質問: ${question}` }
                    ],
                    max_tokens: 60
                })
            });
            const data = await res.json();
            if(data.error) return "API Error: " + data.error.message;
            return data.choices[0].message.content.trim();
        } catch(e) {
            console.error(e);
            return "通信エラーが発生しました";
        }
    },

    /* --- GAME NETWORK LOGIC --- */
    initNetwork: () => {
        Host.apiKey = document.getElementById('h-apikey').value;
        if(!Host.apiKey) return alert("APIキーを入力してください");

        Host.peer = new Peer();
        Host.peer.on('open', id => {
            const url = `${location.href.split('?')[0]}?mode=client&host=${id}`;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: url, width: 128, height: 128 });
            
            document.getElementById('h-screen-setup').classList.add('hidden');
            document.getElementById('h-screen-lobby').classList.remove('hidden');
        });

        Host.peer.on('connection', conn => {
            Host.conns[conn.peer] = conn;
            conn.on('data', data => {
                if(data.type === 'JOIN') {
                    Host.players[conn.peer] = { name: data.name, id: conn.peer };
                    Host.updateLobby();
                }
                else if(data.type === 'QUESTION') Host.handleQuestion(data.text);
                else if(data.type === 'ANSWER') Host.handleAnswer(conn.peer, data.text);
                else if(data.type === 'JUDGE') Host.handleJudge(data.index);
            });
            conn.on('close', () => {
                delete Host.players[conn.peer];
                delete Host.conns[conn.peer];
                Host.updateLobby();
            });
        });
    },

    updateLobby: () => {
        const ids = Object.keys(Host.players);
        document.getElementById('h-count').innerText = ids.length;
        const list = document.getElementById('h-player-list');
        list.innerHTML = ids.map(id => `<div class="player-chip">${Host.players[id].name}</div>`).join('');
        document.getElementById('h-btn-start').disabled = ids.length < 2;
    },

    broadcast: (data) => Object.values(Host.conns).forEach(c => c.send(data)),

    // 2. Game Start
    startGame: () => {
        const ids = Object.keys(Host.players);
        if (ids.length < 2) return;

        Host.state.answers = [];
        const candidatesA = [...ids, "AI"];
        const bId = ids[Math.floor(Math.random() * ids.length)];
        let aId = bId;
        while(aId === bId) {
            aId = candidatesA[Math.floor(Math.random() * candidatesA.length)];
        }

        const isAI = (aId === "AI");
        const aName = isAI ? "AI" : Host.players[aId].name;
        const bName = Host.players[bId].name;

        Host.state.roleA = { id: aId, name: aName, isAI: isAI };
        Host.state.roleB = { id: bId, name: bName };

        // UI Update
        document.getElementById('h-screen-lobby').classList.add('hidden');
        document.getElementById('h-screen-game').classList.remove('hidden');
        document.getElementById('h-phase-title').innerText = "役割確認中";
        document.getElementById('h-game-content').innerHTML = `
            <p>ターゲット(A): <strong style="color:var(--accent); font-size:1.5em;">${aName}</strong></p>
            <p>質問者(B): <strong style="color:var(--accent); font-size:1.5em;">${bName}</strong></p>
            <p style="margin-top:20px; color:#888;">Bが質問を入力するのを待っています...</p>
        `;

        Host.broadcast({ type: 'ROLE_ASSIGN', roleA: Host.state.roleA, roleB: Host.state.roleB });
    },

    // 3. Question Phase
    handleQuestion: (text) => {
        Host.state.question = text;
        document.getElementById('h-phase-title').innerText = "回答フェーズ";
        document.getElementById('h-game-content').innerHTML = `
            <div style="color:#888;">質問</div>
            <div style="font-size:1.5em; font-weight:bold; margin-bottom:20px;">${text}</div>
            <div id="h-ans-status">回答を待っています...</div>
        `;
        Host.broadcast({ type: 'PHASE_ANSWER', question: text });
        Host.callAI(text); // Trigger AI
    },

    callAI: async (question) => {
        const isTargetAI = Host.state.roleA.isAI;
        // If A is AI -> Target Mode. If A is Human -> Impostor Mode.
        const mode = isTargetAI ? 'AI' : 'HUMAN';
        
        const ansText = await Host.generateAIResponse(Host.apiKey, mode, question);
        Host.state.answers.push({ id: "AI", text: ansText, isAI: true });
        Host.checkAllAnswers();
    },

    handleAnswer: (pid, text) => {
        Host.state.answers.push({ id: pid, text: text, isAI: false });
        document.getElementById('h-ans-status').innerText = `${Host.state.answers.length}人が回答済み`;
        Host.checkAllAnswers();
    },

    checkAllAnswers: () => {
        const totalPlayers = Object.keys(Host.players).length;
        const required = (totalPlayers - 1) + 1; // Clients - B + AI

        if (Host.state.answers.length >= required) {
            Utils.shuffle(Host.state.answers);
            
            document.getElementById('h-phase-title').innerText = "推理フェーズ";
            let html = `<p>Bが回答を選んでいます...</p><div style="text-align:left;">`;
            Host.state.answers.forEach(a => html += `<div class="answer-box">${a.text}</div>`);
            html += `</div>`;
            document.getElementById('h-game-content').innerHTML = html;

            Host.broadcast({ type: 'PHASE_JUDGE', answers: Host.state.answers });
        }
    },

    // 4. Result Phase
    handleJudge: (index) => {
        const selected = Host.state.answers[index];
        const isCorrect = (selected.id === Host.state.roleA.id);
        
        let html = isCorrect ? 
            `<h1 style="color:var(--success); font-size:3em;">正解！</h1>` : 
            `<h1 style="color:var(--danger); font-size:3em;">不正解...</h1>`;
        
        const author = selected.isAI ? "AI" : Host.players[selected.id].name;
        html += `<p>選んだ回答: <strong>${selected.text}</strong></p>`;
        html += `<p>この回答の主: <strong>${author}</strong></p>`;
        html += `<hr style="border-color:#444; margin:20px 0;"><h3>【内訳】</h3>`;
        
        Host.state.answers.forEach(a => {
            let name = a.isAI ? "AI" : Host.players[a.id].name;
            let mark = (a.id === Host.state.roleA.id) ? " <span style='color:var(--accent);'>(本物)</span>" : "";
            html += `<div style="border-bottom:1px solid #444; padding:5px;">${name}: ${a.text}${mark}</div>`;
        });

        html += `<button onclick="Host.resetGame()" style="margin-top:30px;">ロビーへ戻る</button>`;
        document.getElementById('h-game-content').innerHTML = html;
        Host.broadcast({ type: 'RESULT', success: isCorrect });
    },

    resetGame: () => {
        document.getElementById('h-screen-game').classList.add('hidden');
        document.getElementById('h-screen-lobby').classList.remove('hidden');
        Host.broadcast({ type: 'RESET' });
    }
};

/* ================= CLIENT LOGIC (MOBILE) ================= */
const Client = {
    conn: null, name: "",
    init: (hostId) => {
        document.getElementById('host-app').classList.add('hidden');
        document.getElementById('client-app').classList.remove('hidden');
        
        const peer = new Peer();
        peer.on('open', () => {
            Client.conn = peer.connect(hostId);
            Client.conn.on('data', data => Client.handleData(data));
            Client.conn.on('close', () => { alert("接続が切れました"); location.reload(); });
        });
    },

    join: () => {
        const name = document.getElementById('c-name').value;
        if(!name) return;
        Client.name = name;
        if(Client.conn) {
            Client.conn.send({ type: 'JOIN', name: name });
            document.getElementById('c-screen-login').classList.add('hidden');
            document.getElementById('c-screen-main').classList.remove('hidden');
            document.getElementById('c-disp-name').innerText = name;
        } else alert("接続準備中です...");
    },

    handleData: (data) => {
        const uiGame = document.getElementById('c-game-area');
        const uiMsg = document.getElementById('c-status-msg');
        const uiInput = document.getElementById('c-input-text');
        const uiLabel = document.getElementById('c-area-label');
        const uiBtn = document.getElementById('c-btn-submit');
        const uiRole = document.getElementById('c-role-area');
        const uiJudge = document.getElementById('c-judge-area');

        if (data.type === 'ROLE_ASSIGN') {
            uiRole.classList.remove('hidden');
            const myId = Client.conn.provider.id;
            const isB = (myId === data.roleB.id);
            
            document.getElementById('c-role-text').innerText = isB ? "あなたは【質問者 B】" : "あなたは【回答者】";
            document.getElementById('c-instruction').innerText = isB ? 
                `A (${data.roleA.name}) への質問を考えてください` : 
                `A (${data.roleA.name}) になりすまして回答します`;
            
            // Set Input for B (Question)
            if (isB) {
                Client.toggleInput(true, "質問を入力", "質問を送信");
                Client.actionType = 'QUESTION';
                uiMsg.innerText = "質問を入力してください";
            } else {
                Client.toggleInput(false);
                uiMsg.innerText = "質問者が質問を考え中...";
            }
        }
        else if (data.type === 'PHASE_ANSWER') {
            const myId = Client.conn.provider.id;
            // Check if I am B (who sent question)
            if (Client.actionType === 'QUESTION') {
                // I am B -> Wait
                Client.toggleInput(false);
                uiMsg.innerText = "みんなが回答しています...";
            } else {
                // I am Answerer
                Client.toggleInput(true, `質問: ${data.question}`, "回答を送信");
                Client.actionType = 'ANSWER';
                uiMsg.innerText = "Aになりすまして回答してください";
            }
        }
        else if (data.type === 'PHASE_JUDGE') {
            Client.toggleInput(false);
            if (Client.actionType === 'QUESTION') {
                // I am B -> Show Judge Buttons
                uiMsg.classList.add('hidden');
                uiJudge.classList.remove('hidden');
                const list = document.getElementById('c-judge-list');
                list.innerHTML = "";
                data.answers.forEach((ans, idx) => {
                    const btn = document.createElement('button');
                    btn.innerText = ans.text;
                    btn.style.marginBottom = "10px";
                    btn.onclick = () => {
                        Client.conn.send({ type: 'JUDGE', index: idx });
                    };
                    list.appendChild(btn);
                });
            } else {
                uiMsg.innerText = "質問者が推理中...";
            }
        }
        else if (data.type === 'RESULT') {
            uiJudge.classList.add('hidden');
            uiMsg.classList.remove('hidden');
            uiMsg.innerText = data.success ? "Bの正解！" : "不正解...";
        }
        else if (data.type === 'RESET') {
            uiRole.classList.add('hidden');
            uiMsg.innerText = "次のゲームを待機中...";
            Client.actionType = null;
        }
    },

    toggleInput: (enable, placeholder = "", btnText = "") => {
        const area = document.getElementById('c-game-area');
        const input = document.getElementById('c-input-text');
        const btn = document.getElementById('c-btn-submit');
        const label = document.getElementById('c-area-label');

        if(enable) {
            area.classList.remove('ui-disabled');
            input.value = "";
            input.placeholder = placeholder;
            label.innerText = placeholder;
            btn.innerText = btnText;
        } else {
            area.classList.add('ui-disabled');
        }
    },

    sendAction: () => {
        const text = document.getElementById('c-input-text').value;
        if(!text) return;
        
        if (Client.actionType === 'QUESTION') {
            Client.conn.send({ type: 'QUESTION', text: text });
            Client.toggleInput(false);
            document.getElementById('c-status-msg').innerText = "回答を待っています...";
        } else if (Client.actionType === 'ANSWER') {
            Client.conn.send({ type: 'ANSWER', text: text });
            Client.toggleInput(false);
            document.getElementById('c-status-msg').innerText = "他の回答を待っています...";
        }
    }
};

// Start
Host.init();
</script>
</body>
</html>
